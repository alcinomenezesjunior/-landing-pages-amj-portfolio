{
  "name": "BACKEND - Essenza Prime (ATUALIZADO)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "testar-bot-whatsapp",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "df0410f8-874b-4489-84cd-433939030a40",
      "name": "Webhook â€“ WhatsApp Incoming",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -720,
        -256
      ],
      "webhookId": "essenza-prime-demo",
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Parse incoming WhatsApp message\nconst body = $input.item.json.body;\n\n// Extract message data\nconst phone = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.from || '';\nconst messageText = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.text?.body || '';\nconst messageId = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.id || '';\nconst timestamp = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.timestamp || '';\n\n// Check if this is a valid message\nif (!phone || !messageText) {\n  return {\n    json: {\n      skip: true,\n      reason: 'No valid message data'\n    }\n  };\n}\n\nreturn {\n  json: {\n    skip: false,\n    phone: phone,\n    message: messageText,\n    messageId: messageId,\n    timestamp: timestamp,\n    receivedAt: new Date().toISOString()\n  }\n};"
      },
      "id": "1996be8d-21c2-44b1-997f-ec86c20b6eb1",
      "name": "Code â€“ Parse Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -496,
        -256
      ],
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.skip}}",
              "value2": false
            }
          ]
        },
        "options": {}
      },
      "id": "c53470ff-ccca-4bbf-85e5-fec45c64365c",
      "name": "IF â€“ Valid Message?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -272,
        -256
      ],
      "disabled": true
    },
    {
      "parameters": {
        "operation": "select"
      },
      "id": "0f79ee4a-7887-49b3-be82-be94be71c202",
      "name": "Supabase â€“ Get Client",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -48,
        -256
      ],
      "credentials": {
        "supabaseApi": {
          "id": "5FmNwSU32HCxPptn",
          "name": "Supabase account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.length > 0}}",
              "value2": true
            }
          ]
        },
        "options": {}
      },
      "id": "877269e7-d76d-47d7-bae9-9726d8a3807b",
      "name": "IF â€“ Client Exists?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        176,
        -256
      ],
      "disabled": true
    },
    {
      "parameters": {
        "operation": "insert"
      },
      "id": "a7580fb5-3ac0-44ca-a16e-e9a34101a916",
      "name": "Supabase â€“ Create Client",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        400,
        -192
      ],
      "credentials": {
        "supabaseApi": {
          "id": "5FmNwSU32HCxPptn",
          "name": "Supabase account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "operation": "select"
      },
      "id": "7e37b82b-88a7-48d6-99de-1ba46d9a696c",
      "name": "Supabase â€“ Get Conversation",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        624,
        -256
      ],
      "credentials": {
        "supabaseApi": {
          "id": "5FmNwSU32HCxPptn",
          "name": "Supabase account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Merge client and conversation data\nconst parseData = $('Code â€“ Parse Message').first().json;\nconst clientData = $('IF â€“ Client Exists?').all()[0]?.json || $('Supabase â€“ Create Client').first().json;\nconst conversationData = $input.first().json;\n\nreturn {\n  json: {\n    phone: parseData.phone,\n    message: parseData.message,\n    messageId: parseData.messageId,\n    clientId: clientData.id,\n    clientName: clientData.name || null,\n    clientEmail: clientData.email || null,\n    conversationId: conversationData.id || null,\n    conversationState: conversationData.current_state || 'inicio',\n    conversationContext: conversationData.context || {},\n    conversationHistory: conversationData.messages || []\n  }\n};"
      },
      "id": "3013a257-ea75-4cec-bdd5-8f623cfa028c",
      "name": "Code â€“ Merge Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        848,
        -256
      ],
      "disabled": true
    },
    {
      "parameters": {
        "options": {
          "systemMessage": "Ã‰s a assistente virtual da Essenza Prime Clinic, uma clÃ­nica de estÃ©tica premium em Cascais, Lisboa.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nPERSONALIDADE E TOM\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n- Nome: NÃ£o tens nome especÃ­fico, Ã©s \"a assistente da Essenza Prime\"\n- Tom: Profissional mas acolhedor, elegante, nunca robÃ³tico\n- Linguagem: PortuguÃªs de Portugal (PT-PT), NUNCA brasileiro\n  - \"telemÃ³vel\" (nÃ£o \"celular\")\n  - \"autocarro\" (nÃ£o \"Ã´nibus\")\n  - \"marcaÃ§Ã£o\" (nÃ£o \"agendamento\")\n  - \"pequeno-almoÃ§o\" (nÃ£o \"cafÃ© da manhÃ£\")\n- Estilo: Frases claras e concisas, adequadas para WhatsApp\n- Emojis: Usa com moderaÃ§Ã£o (mÃ¡ximo 2 por mensagem)\n- Comprimento: Respostas curtas para perguntas simples, detalhadas quando necessÃ¡rio\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nO TEU PAPEL\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. Apresentar a clÃ­nica e os serviÃ§os quando o cliente chega\n2. Responder a perguntas sobre procedimentos, preÃ§os, duraÃ§Ãµes\n3. Informar sobre contraindicaÃ§Ãµes quando relevante\n4. Verificar disponibilidade de horÃ¡rios (usa tool check_availability)\n5. Fazer marcaÃ§Ãµes no calendÃ¡rio (usa tool create_booking)\n6. Gerar links de pagamento para depÃ³sitos (usa tool generate_payment_link)\n7. Processar cancelamentos e reagendamentos\n8. Processar reembolsos conforme polÃ­tica\n9. Sugerir upsells apÃ³s marcaÃ§Ã£o confirmada\n10. Oferecer downsells quando cliente quer cancelar por preÃ§o\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nMENSAGEM INICIAL\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nQuando o cliente envia a primeira mensagem (ex: \"OlÃ¡\", \"Quero testar\", etc.),\nresponde com uma apresentaÃ§Ã£o elegante:\n\n\"Bem-vinda Ã  Essenza Prime Clinic! âœ¨\n\nSou a assistente virtual e posso ajudar-te com:\nâ€¢ InformaÃ§Ãµes sobre tratamentos\nâ€¢ MarcaÃ§Ã£o de consultas\nâ€¢ VerificaÃ§Ã£o de disponibilidade\n\nA nossa clÃ­nica em Cascais oferece tratamentos faciais, corporais e micropigmentaÃ§Ã£o, com uma equipa de 8 especialistas.\n\nComo posso ajudar-te hoje?\"\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nDADOS DA CLÃNICA\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nNome: Essenza Prime Clinic, Unipessoal Lda.\nMorada: Cascais, Lisboa\nHorÃ¡rio: Segunda a Sexta 10:00-19:00, SÃ¡bado 10:00-14:00\nTelefone/WhatsApp: +351 926 699 009\nEmail: atendimento@essenzaprimeclinic.pt\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nEQUIPA (8 PROFISSIONAIS)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. Dr. Gustavo MendonÃ§a â€” MÃ©dico Esteta\n   ServiÃ§os: Peelings mÃ©dio/profundo, HarmonizaÃ§Ã£o, Preenchimentos\n   HorÃ¡rio: Seg-Sex 10:00-16:00\n\n2. Dra. Bruna Cortez â€” BiomÃ©dica Esteta\n   ServiÃ§os: Microagulhamento, Peelings, Limpeza, RadiofrequÃªncia\n   HorÃ¡rio: Ter/Qui/Sex 13:00-19:00, SÃ¡b 10:00-14:00\n\n3. Sra. SÃ­lvia Ramos â€” Esteticista Facial\n   ServiÃ§os: Limpeza de pele, Massagens, RadiofrequÃªncia facial\n   HorÃ¡rio: Seg/Qua/Sex 10:00-19:00, SÃ¡b 10:00-14:00\n\n4. Sra. Carla MagalhÃ£es â€” Esteticista Corporal\n   ServiÃ§os: Massagem modeladora, Drenagem, CriolipÃ³lise, RF corporal\n   HorÃ¡rio: Seg-Sex 13:00-19:00, SÃ¡b 10:00-14:00\n\n5. Sra. InÃªs Duarte â€” Especialista MicropigmentaÃ§Ã£o\n   ServiÃ§os: Microblading, MicropigmentaÃ§Ã£o lÃ¡bios/olhos\n   HorÃ¡rio: Seg/Qua/Qui 10:00-16:00, SÃ¡b 10:00-14:00\n\n6. Sra. Larissa GalvÃ£o â€” Esteticista Multidisciplinar\n   ServiÃ§os: Limpeza, Peelings superficiais, Microagulhamento, CriolipÃ³lise\n   HorÃ¡rio: Ter 10:00-19:00, Sex 10:00-13:00\n\n7. Sr. Pedro Moreira â€” Terapeuta Corporal\n   ServiÃ§os: Massagens, RF corporal, CriolipÃ³lise\n   HorÃ¡rio: Seg/Qua/Sex 16:00-19:00, SÃ¡b 10:00-14:00\n\n8. Sra. Renata Pinto â€” Assistente/Consultora\n   ServiÃ§os: AvaliaÃ§Ã£o inicial, OrientaÃ§Ã£o\n   HorÃ¡rio: Seg-Sex 10:00-19:00, SÃ¡b 10:00-14:00\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nCATÃLOGO DE SERVIÃ‡OS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nTRATAMENTOS FACIAIS:\nâ€¢ Limpeza de Pele Profunda â€” â‚¬40 (60-90 min)\nâ€¢ Peeling Superficial â€” â‚¬80 (30-45 min)\nâ€¢ Peeling MÃ©dio â€” â‚¬160 (45-60 min)\nâ€¢ RadiofrequÃªncia Facial â€” â‚¬100 (30-45 min)\nâ€¢ Microagulhamento â€” â‚¬120 (45-60 min)\nâ€¢ Ultrassom Microfocado (HIFU) â€” â‚¬200 (60-90 min)\nâ€¢ HarmonizaÃ§Ã£o Facial â€” â‚¬600 (60-90 min)\n\nTRATAMENTOS CORPORAIS:\nâ€¢ Massagem TerapÃªutica â€” â‚¬50 (50-60 min)\nâ€¢ Massagem Modeladora â€” â‚¬60 (50-60 min)\nâ€¢ Drenagem LinfÃ¡tica â€” â‚¬60 (50-60 min)\nâ€¢ RadiofrequÃªncia Corporal â€” â‚¬100 (45-60 min)\nâ€¢ CriolipÃ³lise â€” â‚¬120 (60-90 min)\nâ€¢ Massagem Detox â€” â‚¬55 (50-60 min)\n\nMICROPIGMENTAÃ‡ÃƒO:\nâ€¢ Microblading Sobrancelhas â€” â‚¬250 (90-120 min)\nâ€¢ MicropigmentaÃ§Ã£o LÃ¡bios â€” â‚¬280 (90-120 min)\nâ€¢ MicropigmentaÃ§Ã£o Eyeliner â€” â‚¬240 (60-90 min)\n\nCONSULTAS:\nâ€¢ AvaliaÃ§Ã£o Inicial â€” Gratuita (30 min)\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nPOLÃTICA DE DEPÃ“SITO E PAGAMENTO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nâ€¢ DepÃ³sito: 50% do valor total para confirmar marcaÃ§Ã£o\nâ€¢ DepÃ³sito mÃ­nimo: â‚¬20 (se procedimento < â‚¬40)\nâ€¢ Saldo: Pago no dia do procedimento\nâ€¢ Formas: MB WAY, TransferÃªncia, Multibanco, CartÃ£o (presencial)\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nPOLÃTICA DE CANCELAMENTO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nâ€¢ 7+ dias antes: 100% reembolso\nâ€¢ 3-7 dias antes: 75% reembolso (25% retenÃ§Ã£o)\nâ€¢ < 3 dias (atÃ© 24h): 50% reembolso\nâ€¢ < 24 horas: 25% reembolso\nâ€¢ NÃ£o comparecimento (no-show): 0% reembolso\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nFLUXO DE MARCAÃ‡ÃƒO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. Cliente indica interesse num serviÃ§o\n2. Explica o serviÃ§o (duraÃ§Ã£o, preÃ§o, o que inclui)\n3. Pergunta se quer marcar\n4. Verifica disponibilidade (tool: check_availability)\n5. Apresenta 3-5 opÃ§Ãµes de horÃ¡rio\n6. Cliente escolhe\n7. Pede: nome completo e email\n8. Confirma todos os dados\n9. Gera link de pagamento (tool: generate_payment_link)\n10. Aguarda confirmaÃ§Ã£o de pagamento\n11. Cria marcaÃ§Ã£o (tool: create_booking)\n12. Envia confirmaÃ§Ã£o final\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nUPSELL (ApÃ³s MarcaÃ§Ã£o Confirmada)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nQuando uma marcaÃ§Ã£o Ã© confirmada, sugere um serviÃ§o complementar:\n\nâ€¢ Limpeza de Pele â†’ Peeling Superficial (10% desconto)\nâ€¢ Peeling Superficial â†’ RadiofrequÃªncia Facial (10%)\nâ€¢ RadiofrequÃªncia â†’ Microagulhamento (10%)\nâ€¢ Massagem TerapÃªutica â†’ Drenagem LinfÃ¡tica (15%)\nâ€¢ Microblading â†’ MicropigmentaÃ§Ã£o LÃ¡bios (10%)\nâ€¢ CriolipÃ³lise â†’ RF Corporal (15%)\n\nExemplo de mensagem:\n\"A tua marcaÃ§Ã£o estÃ¡ confirmada! âœ…\n\nğŸ’¡ Muitas clientes combinam a Limpeza de Pele com um Peeling Superficial para resultados ainda melhores.\n\nğŸ Por marcares agora, tens 10% de desconto: â‚¬80 â†’ â‚¬72\n\nQueres adicionar? A Dra. Bruna tem disponibilidade logo apÃ³s.\"\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nDOWNSELL (No Cancelamento por PreÃ§o)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSe o cliente quer cancelar e menciona preÃ§o/dinheiro:\n\nâ€¢ Peeling MÃ©dio (â‚¬160) â†’ Peeling Superficial (â‚¬80)\nâ€¢ HarmonizaÃ§Ã£o (â‚¬600) â†’ RadiofrequÃªncia Facial (â‚¬100)\nâ€¢ Microagulhamento (â‚¬120) â†’ Limpeza de Pele (â‚¬40)\n\nExemplo:\n\"Entendo que o Peeling MÃ©dio Ã© um investimento maior.\n\nTenho uma alternativa: o Peeling Superficial (â‚¬80) tambÃ©m melhora manchas e textura, com menos tempo de recuperaÃ§Ã£o.\n\nO teu depÃ³sito de â‚¬80 cobre o valor total! Queres trocar em vez de cancelar?\"\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nLIVRO DE RECLAMAÃ‡Ã•ES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSe perguntarem sobre reclamaÃ§Ãµes:\n\n\"A Essenza Prime Clinic disponibiliza o Livro de ReclamaÃ§Ãµes EletrÃ³nico conforme a legislaÃ§Ã£o portuguesa.\n\nPodes aceder em: www.livroreclamacoes.pt\n\nSe preferires resolver directamente, posso pedir a um responsÃ¡vel para te contactar. O que preferes?\"\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nREGRAS IMPORTANTES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. NUNCA inventes informaÃ§Ã£o â€” usa apenas o que estÃ¡ acima\n2. NUNCA digas que Ã©s demo ou teste â€” age como assistente real\n3. SEMPRE verifica disponibilidade antes de confirmar marcaÃ§Ã£o\n4. SEMPRE confirma dados antes de criar evento\n5. SEMPRE informa sobre depÃ³sito de 50%\n6. SEMPRE usa PT-PT, nunca portuguÃªs do Brasil\n7. Se nÃ£o souberes algo, oferece contacto humano:\n   \"Posso pedir a um colega para te contactar para esclarecer isso.\"\n8. SÃª empÃ¡tica com cancelamentos â€” nÃ£o julgues\n9. Quando o cliente mencionar dificuldade financeira, oferece alternativas\n10. MantÃ©m histÃ³rico da conversa â€” nÃ£o perguntes o que jÃ¡ foi dito"
        }
      },
      "id": "541c2cf5-8dc5-4cb6-bd49-5d98d402f46b",
      "name": "AI Agent â€“ Claude Sonnet 4",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        1072,
        -256
      ],
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Process AI response and prepare for database update\nconst aiResponse = $input.first().json;\nconst mergedData = $('Code â€“ Merge Data').first().json;\n\n// Add new message to history\nconst messages = mergedData.conversationHistory || [];\nmessages.push({\n  role: 'user',\n  content: mergedData.message,\n  timestamp: new Date().toISOString()\n});\nmessages.push({\n  role: 'assistant',\n  content: aiResponse.output,\n  timestamp: new Date().toISOString()\n});\n\n// Keep only last 20 messages for context\nconst trimmedMessages = messages.slice(-20);\n\n// Extract any booking intent from context\nconst hasBookingIntent = aiResponse.output.toLowerCase().includes('marcar') || \n                         aiResponse.output.toLowerCase().includes('disponibilidade');\n\nreturn {\n  json: {\n    phone: mergedData.phone,\n    clientId: mergedData.clientId,\n    conversationId: mergedData.conversationId,\n    messages: trimmedMessages,\n    currentState: hasBookingIntent ? 'choosing_service' : mergedData.conversationState,\n    responseText: aiResponse.output,\n    toolsUsed: aiResponse.toolCalls || []\n  }\n};"
      },
      "id": "d7551e43-6e59-4f16-9459-cfc00e24a933",
      "name": "Code â€“ Process Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1424,
        -256
      ],
      "disabled": true
    },
    {
      "parameters": {
        "operation": "upsert"
      },
      "id": "b4d6d87e-8dfd-4e8b-ae72-79fd321e1cd8",
      "name": "Supabase â€“ Update Conversation",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1648,
        -256
      ],
      "credentials": {
        "supabaseApi": {
          "id": "5FmNwSU32HCxPptn",
          "name": "Supabase account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v18.0/{{$env.WHATSAPP_PHONE_NUMBER_ID}}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{$('Code â€“ Process Response').item.json.phone}}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"{{$('Code â€“ Process Response').item.json.responseText}}\"\n  }\n}",
        "options": {}
      },
      "id": "33816a95-39fa-4251-b8aa-5bf967a02dcd",
      "name": "WhatsApp â€“ Send Message",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1872,
        -256
      ],
      "disabled": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"status\": \"success\", \"message\": \"Message processed\"}",
        "options": {}
      },
      "id": "03a9154e-ae5a-41c2-ab98-f3f3c24e2639",
      "name": "Webhook Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        2096,
        -256
      ],
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// PLACEHOLDER: AI Agent vai aqui\n// Por enquanto, resposta de teste\n\nconst mergedData = $input.first().json;\n\nreturn {\n  json: {\n    responseText: `âœ… Backend funcionando! Mensagem de ${mergedData.phone}: \"${mergedData.message}\"\\n\\nâš ï¸ AI Agent ainda nÃ£o configurado - siga o guia para adicionar.`,\n    phone: mergedData.phone,\n    clientId: mergedData.clientId,\n    conversationId: mergedData.conversationId\n  }\n};"
      },
      "id": "ca2380cc-d675-4d8b-9910-8d0a9f0f0bfa",
      "name": "PLACEHOLDER â€“ AI Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1072,
        48
      ],
      "disabled": true
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "testar-bot-whatsapp",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "46c2ed6b-da7e-4b71-9c05-48c1110bcf5f",
      "name": "Webhook â€“ WhatsApp Incoming1",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -720,
        48
      ],
      "webhookId": "essenza-prime-demo",
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Parse incoming WhatsApp message\nconst body = $input.item.json.body;\n\n// Extract message data\nconst phone = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.from || '';\nconst messageText = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.text?.body || '';\nconst messageId = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.id || '';\nconst timestamp = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.timestamp || '';\n\n// Check if this is a valid message\nif (!phone || !messageText) {\n  return {\n    json: {\n      skip: true,\n      reason: 'No valid message data'\n    }\n  };\n}\n\nreturn {\n  json: {\n    skip: false,\n    phone: phone,\n    message: messageText,\n    messageId: messageId,\n    timestamp: timestamp,\n    receivedAt: new Date().toISOString()\n  }\n};"
      },
      "id": "5c3ba913-e4ad-4d25-89bc-07e51bd5e378",
      "name": "Code â€“ Parse Message1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -496,
        48
      ],
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.skip}}",
              "value2": false
            }
          ]
        },
        "options": {}
      },
      "id": "5bf06de1-2b6e-4990-8041-62953eb02515",
      "name": "IF â€“ Valid Message?1",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -272,
        48
      ],
      "disabled": true
    },
    {
      "parameters": {
        "operation": "select"
      },
      "id": "77138589-1669-4121-ace6-c75cabc282b6",
      "name": "Supabase â€“ Get Client1",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -48,
        48
      ],
      "credentials": {
        "supabaseApi": {
          "id": "5FmNwSU32HCxPptn",
          "name": "Supabase account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.length > 0}}",
              "value2": true
            }
          ]
        },
        "options": {}
      },
      "id": "6de69937-1805-4983-bf9e-9a182af2e9d0",
      "name": "IF â€“ Client Exists?1",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        176,
        48
      ],
      "disabled": true
    },
    {
      "parameters": {
        "operation": "insert"
      },
      "id": "f0f1d28a-197a-417b-ad69-381a07ebaba3",
      "name": "Supabase â€“ Create Client1",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        400,
        112
      ],
      "credentials": {
        "supabaseApi": {
          "id": "5FmNwSU32HCxPptn",
          "name": "Supabase account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "operation": "select"
      },
      "id": "47517316-f9c4-4ecb-883b-09a80ae76575",
      "name": "Supabase â€“ Get Conversation1",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        624,
        48
      ],
      "credentials": {
        "supabaseApi": {
          "id": "5FmNwSU32HCxPptn",
          "name": "Supabase account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Merge client and conversation data\nconst parseData = $('Code â€“ Parse Message1').first().json;\nconst clientData = $('IF â€“ Client Exists?1').all()[0]?.json || $('Supabase â€“ Create Client1').first().json;\nconst conversationData = $input.first().json;\n\nreturn {\n  json: {\n    phone: parseData.phone,\n    message: parseData.message,\n    messageId: parseData.messageId,\n    clientId: clientData.id,\n    clientName: clientData.name || null,\n    clientEmail: clientData.email || null,\n    conversationId: conversationData.id || null,\n    conversationState: conversationData.current_state || 'inicio',\n    conversationContext: conversationData.context || {},\n    conversationHistory: conversationData.messages || []\n  }\n};"
      },
      "id": "5ff8fa7d-8ef4-4726-b304-3d0a871398ed",
      "name": "Code â€“ Merge Data1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        848,
        48
      ],
      "disabled": true
    },
    {
      "parameters": {
        "operation": "upsert"
      },
      "id": "963a3159-4fa7-4e25-9637-35b02f867da9",
      "name": "Supabase â€“ Update Conversation1",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1296,
        48
      ],
      "credentials": {
        "supabaseApi": {
          "id": "5FmNwSU32HCxPptn",
          "name": "Supabase account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v18.0/{{$env.WHATSAPP_PHONE_NUMBER_ID}}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{$('PLACEHOLDER â€“ AI Response').item.json.phone}}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"{{$('PLACEHOLDER â€“ AI Response').item.json.responseText}}\"\n  }\n}",
        "options": {}
      },
      "id": "4d43e3d3-661d-4c46-8c5b-5c8dddcdcbc4",
      "name": "WhatsApp â€“ Send Message1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1520,
        48
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "msDucOJHTeBau1zJ",
          "name": "WhatsApp API Cloud"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "=={\"status\": \"success\", \"message\": \"Message processed\"}",
        "options": {}
      },
      "id": "5ccaf7d5-d705-4d3b-8271-4865e6794128",
      "name": "Webhook Response1",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1744,
        48
      ],
      "disabled": true
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "testar-bot-whatsapp",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "a38e6cb8-1561-455f-ae08-aa72bc13e54d",
      "name": "Webhook WhatsApp",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -720,
        432
      ],
      "webhookId": "essenza-prime-webhook"
    },
    {
      "parameters": {
        "jsCode": "const body = $input.item.json.body;\nconst phone = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.from || '';\nconst messageText = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.text?.body || '';\nconst messageId = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.id || '';\n\nif (!phone || !messageText) {\n  return { json: { skip: true, reason: 'No valid message' } };\n}\n\nreturn {\n  json: {\n    skip: false,\n    phone: phone,\n    message: messageText,\n    messageId: messageId,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "46569360-3112-4900-9bfb-f37d7ce4669a",
      "name": "Parse Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -496,
        432
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.skip}}",
              "value2": false
            }
          ]
        },
        "options": {}
      },
      "id": "f84a8ee2-aeda-4d3f-854c-f36a92881660",
      "name": "Valid Message?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -272,
        432
      ]
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "clients",
        "filterType": "string",
        "filterString": "=phone=eq.{{ $('Parse Message').item.json.phone }}"
      },
      "id": "a8acd64e-169a-4211-80ca-4195d36872ce",
      "name": "Get Client",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -48,
        432
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "5FmNwSU32HCxPptn",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "8ff474e9-f0ee-442e-9b2d-6be79b4222ec",
              "leftValue": "={{ $json.id }}",
              "rightValue": 0,
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "85fc3784-d802-4340-8435-8f3139588f2f",
      "name": "Client Exists?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        176,
        432
      ],
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "jsCode": "// Busca os dados do nÃ³ Parse Message\nconst parseData = $('Parse Message').first().json;\n\n// Retorna os dados no formato esperado pelo Create Client\nreturn {\n  json: {\n    phone: parseData.phone\n  }\n};"
      },
      "id": "code-prepare-client",
      "name": "Prepare Client Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 500]
    },
    {
      "parameters": {
        "operation": "create",
        "tableId": "clients",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "phone",
              "fieldValue": "={{ $json.phone }}"
            }
          ]
        }
      },
      "id": "c57f99ef-4e91-44e4-bbc3-e76394922bba",
      "name": "Create Client",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1560, 500],
      "credentials": {
        "supabaseApi": {
          "id": "5FmNwSU32HCxPptn",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "conversations",
        "filters": {
          "conditions": [
            {
              "keyName": "phone",
              "condition": "equals",
              "keyValue": "={{ $('Parse Message').first().json.phone }}"
            }
          ]
        }
      },
      "id": "bb6eb44a-e233-4dbe-84de-6d37fa82e200",
      "name": "Get Conversation",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        624,
        432
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "5FmNwSU32HCxPptn",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const parseData = $('Parse Message').first().json;\nconst clientData = $('Client Exists?').all()[0]?.json || $('Create Client').first().json;\n\n// Pega dados da conversa (pode vir de Create ou Update)\nconst conversationData = $input.first().json;\n\nreturn {\n  json: {\n    phone: parseData.phone,\n    message: parseData.message,\n    messageId: parseData.messageId,\n    clientId: clientData.id,\n    clientName: clientData.name || 'Cliente',\n    conversationId: conversationData.id,\n    timestamp: parseData.timestamp\n  }\n};"
      },
      "id": "8fd6ce20-dd16-4538-883d-a914ee187398",
      "name": "Merge Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1296,
        432
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\n\nreturn {\n  json: {\n    responseText: `âœ… OlÃ¡ ${data.clientName}!\\n\\nRecebi a tua mensagem: \"${data.message}\"\\n\\nâš ï¸ Este Ã© um backend de teste. O AI Agent serÃ¡ adicionado em breve!`,\n    phone: data.phone,\n    clientId: data.clientId\n  }\n};"
      },
      "id": "f97f9dff-d367-4ab3-9644-e000b017f4a0",
      "name": "Generate Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1520,
        432
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v18.0/803198829554410/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.phone }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"{{ $json.responseText }}\"\n  }\n}",
        "options": {}
      },
      "id": "654a3f33-fdbd-4448-ab79-7491c0613f16",
      "name": "Send WhatsApp",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1744,
        432
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "msDucOJHTeBau1zJ",
          "name": "WhatsApp API Cloud"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"status\": \"success\"}",
        "options": {}
      },
      "id": "81db62d7-db4f-4bc1-a9f5-a22a1954d3c9",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1968,
        432
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "conversations",
        "filters": {
          "conditions": [
            {
              "keyName": "phone",
              "condition": "eq",
              "keyValue": "=={{ $('Parse Message').item.json.phone }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "updated_at",
              "fieldValue": "=={{ new Date().toISOString() }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1072,
        336
      ],
      "id": "2680cb56-7d79-4b51-8370-1578addc36c1",
      "name": "Update Conversation",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "5FmNwSU32HCxPptn",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5a597b0b-444e-47c2-8db8-0bb318c9d894",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        848,
        432
      ],
      "id": "c57bc6b5-718a-445f-b3df-dcd7443fa007",
      "name": " Conversation Exists?",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "tableId": "conversations",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "client_id",
              "fieldValue": "=={{ $('Merge Data').item.json.clientId }}"
            },
            {
              "fieldId": "phone",
              "fieldValue": "=={{ $('Parse Message').item.json.phone }}"
            },
            {
              "fieldId": "current_state",
              "fieldValue": "inicio"
            },
            {
              "fieldId": "messages",
              "fieldValue": "=[]"
            },
            {
              "fieldId": "context",
              "fieldValue": "={}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1072,
        528
      ],
      "id": "ef07bd18-2160-4ac8-a42e-cea4d55738b5",
      "name": "Create Conversation",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "5FmNwSU32HCxPptn",
          "name": "Supabase account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook â€“ WhatsApp Incoming": {
      "main": [
        [
          {
            "node": "Code â€“ Parse Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code â€“ Parse Message": {
      "main": [
        [
          {
            "node": "IF â€“ Valid Message?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF â€“ Valid Message?": {
      "main": [
        [
          {
            "node": "Supabase â€“ Get Client",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase â€“ Get Client": {
      "main": [
        [
          {
            "node": "IF â€“ Client Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF â€“ Client Exists?": {
      "main": [
        [
          {
            "node": "Supabase â€“ Get Conversation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Supabase â€“ Create Client",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase â€“ Create Client": {
      "main": [
        [
          {
            "node": "Supabase â€“ Get Conversation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase â€“ Get Conversation": {
      "main": [
        [
          {
            "node": "Code â€“ Merge Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code â€“ Merge Data": {
      "main": [
        [
          {
            "node": "AI Agent â€“ Claude Sonnet 4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent â€“ Claude Sonnet 4": {
      "main": [
        [
          {
            "node": "Code â€“ Process Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code â€“ Process Response": {
      "main": [
        [
          {
            "node": "Supabase â€“ Update Conversation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase â€“ Update Conversation": {
      "main": [
        [
          {
            "node": "WhatsApp â€“ Send Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WhatsApp â€“ Send Message": {
      "main": [
        [
          {
            "node": "Webhook Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PLACEHOLDER â€“ AI Response": {
      "main": [
        [
          {
            "node": "Supabase â€“ Update Conversation1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook â€“ WhatsApp Incoming1": {
      "main": [
        [
          {
            "node": "Code â€“ Parse Message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code â€“ Parse Message1": {
      "main": [
        [
          {
            "node": "IF â€“ Valid Message?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF â€“ Valid Message?1": {
      "main": [
        [
          {
            "node": "Supabase â€“ Get Client1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase â€“ Get Client1": {
      "main": [
        [
          {
            "node": "IF â€“ Client Exists?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF â€“ Client Exists?1": {
      "main": [
        [
          {
            "node": "Supabase â€“ Get Conversation1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Supabase â€“ Create Client1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase â€“ Create Client1": {
      "main": [
        [
          {
            "node": "Supabase â€“ Get Conversation1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase â€“ Get Conversation1": {
      "main": [
        [
          {
            "node": "Code â€“ Merge Data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code â€“ Merge Data1": {
      "main": [
        [
          {
            "node": "PLACEHOLDER â€“ AI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase â€“ Update Conversation1": {
      "main": [
        [
          {
            "node": "WhatsApp â€“ Send Message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WhatsApp â€“ Send Message1": {
      "main": [
        [
          {
            "node": "Webhook Response1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook WhatsApp": {
      "main": [
        [
          {
            "node": "Parse Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Message": {
      "main": [
        [
          {
            "node": "Valid Message?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Valid Message?": {
      "main": [
        [
          {
            "node": "Get Client",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Client": {
      "main": [
        [
          {
            "node": "Client Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Client Exists?": {
      "main": [
        [{"node": "Get Conversation", "type": "main", "index": 0}],
        [{"node": "Prepare Client Data", "type": "main", "index": 0}]
      ]
    },
    "Prepare Client Data": {
      "main": [[{"node": "Create Client", "type": "main", "index": 0}]]
    },
    "Create Client": {
      "main": [
        [
          {
            "node": "Get Conversation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Conversation": {
      "main": [
        [
          {
            "node": " Conversation Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Data": {
      "main": [
        [
          {
            "node": "Generate Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Response": {
      "main": [
        [
          {
            "node": "Send WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send WhatsApp": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Conversation": {
      "main": [
        [
          {
            "node": "Merge Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    " Conversation Exists?": {
      "main": [
        [
          {
            "node": "Update Conversation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create Conversation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Conversation": {
      "main": [
        [
          {
            "node": "Merge Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "924d67c6-641c-4a70-99eb-166b0a8cdae2",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "323c9b0d593df2deec4f9143de66619f0d3c68bbcf06bc32eb698efedd85ea5f"
  },
  "id": "QRVeg9dVcQX734Wd",
  "tags": [
    {
      "updatedAt": "2025-11-21T19:39:50.299Z",
      "createdAt": "2025-11-21T19:39:50.299Z",
      "id": "Qf97p5PodNtekeTK",
      "name": "Demo - Essenza Prime"
    }
  ]
}