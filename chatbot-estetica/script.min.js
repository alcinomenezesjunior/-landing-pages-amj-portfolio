document.addEventListener("DOMContentLoaded",()=>{const $=(s,c=document)=>c.querySelector(s),$$=(s,c=document)=>[...c.querySelectorAll(s)];let formSubmitted=!1;const POPUP_COOLDOWN_MS=18e5,urlParams=new URLSearchParams(window.location.search),isTestMode=urlParams.has("test-popup");function wasPopupShownRecently(){if(isTestMode)return console.log("[Exit-Intent] üß™ Modo de teste ativo - sessionStorage ignorado"),!1;const e=sessionStorage.getItem("chatbotPopupShown");if(!e)return!1;const t=parseInt(e,10),o=Date.now()-t;return o>POPUP_COOLDOWN_MS?(sessionStorage.removeItem("chatbotPopupShown"),!1):(console.log(`[Exit-Intent] Popup foi mostrado h√° ${Math.floor(o/6e4)} minutos`),!0)}let exitPopupShown=wasPopupShownRecently();const leadForm=$("#leadForm"),stickyCta=$("#sticky-cta"),exitPopup=$("#exitPopupChatbot"),successPopup=$("#successPopup"),agencyPopup=$("#exitPopupAgencia"),openPopup=e=>{e&&(e.style.display="flex",document.body.style.overflow="hidden")},closePopup=e=>{e&&(e.classList.remove("active"),e.classList.remove("show"),e.style.display="none",document.body.style.overflow="")};let popupsState={chatbotShown:wasPopupShownRecently(),agenciaShown:!1},lastFocusedElement=null;function trapFocus(e){const t=e.querySelectorAll('a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])');if(0!==t.length){const o=t[0],n=t[t.length-1];o.focus();const a=t=>{if("Tab"===t.key){if(t.shiftKey&&document.activeElement===o)t.preventDefault(),n.focus();else if(!t.shiftKey&&document.activeElement===n)t.preventDefault(),o.focus()}};e.addEventListener("keydown",a),e._focusTrapHandler=a}}function removeFocusTrap(e){e&&e._focusTrapHandler&&(e.removeEventListener("keydown",e._focusTrapHandler),delete e._focusTrapHandler)}window.closePopup=function(e){const t=document.getElementById(e);t&&(t.classList.remove("active"),t.classList.remove("show"),t.style.display="none",document.body.style.overflow="",removeFocusTrap(t),lastFocusedElement&&(lastFocusedElement.focus(),lastFocusedElement=null))};function showChatbotPopup(){if(console.log("[showChatbotPopup] Chamada recebida",{chatbotShown:popupsState.chatbotShown}),popupsState.chatbotShown)return void console.log("[showChatbotPopup] Bloqueado - popup j√° foi mostrado nesta sess√£o");const e=document.getElementById("exitPopupChatbot");e?(console.log("[showChatbotPopup] Abrindo popup..."),lastFocusedElement=document.activeElement,e.classList.add("active"),e.classList.add("show"),e.style.display="flex",document.body.style.overflow="hidden",popupsState.chatbotShown=!0,sessionStorage.setItem("chatbotPopupShown",Date.now().toString()),console.log("[showChatbotPopup] ‚úì Popup aberto com sucesso (expira em 30min)"),trapFocus(e)):console.error("[showChatbotPopup] Elemento #exitPopupChatbot n√£o encontrado!")}window.showChatbotPopup=showChatbotPopup,window.resetPopupState=function(){sessionStorage.removeItem("chatbotPopupShown"),sessionStorage.removeItem("exit_shown"),popupsState.chatbotShown=!1,exitPopupShown=!1,console.log("‚úì Estado do popup resetado - pode testar novamente")},isTestMode&&(console.log("%cüß™ MODO DE TESTE ATIVO","background: #4CAF50; color: white; font-size: 16px; padding: 8px;"),console.log("‚Üí O popup vai aparecer sempre, ignorando sessionStorage"),console.log("‚Üí Para sair do modo de teste, remova ?test-popup=1 do URL")),window.showAgencyPopup=function(){window.closePopup("exitPopupChatbot");const e=document.getElementById("exitPopupAgencia");e&&(lastFocusedElement||(lastFocusedElement=document.activeElement),e.classList.add("active"),e.classList.add("show"),e.style.display="flex",document.body.style.overflow="hidden",popupsState.agenciaShown=!0,trapFocus(e))},window.scrollToPlans=function(){const e=document.querySelector("#planos");e&&e.scrollIntoView({behavior:"smooth",block:"start"})};let exitIntentTriggered=!1;window.trackWhatsAppDemo=e=>("undefined"!=typeof gtag&&gtag("event","click",{event_category:"Demo",event_label:"WhatsApp Bot Test",value:1}),!0);const getDeviceType=()=>{const e=Math.min(window.screen.width,window.innerWidth);return e<600?"mobile":e<1024?"tablet":"desktop"},getBrowser=()=>{const e=navigator.userAgent;return/Chrome/i.test(e)&&!/Edge|OPR/i.test(e)?"Chrome":/Safari/i.test(e)&&!/Chrome/i.test(e)?"Safari":/Firefox/i.test(e)?"Firefox":/Edg/i.test(e)?"Edge":"Other"},getOS=()=>{const e=navigator.userAgent;return/Windows/i.test(e)?"Windows":/Mac OS X/i.test(e)?"macOS":/Android/i.test(e)?"Android":/iPhone|iPad|iOS/i.test(e)?"iOS":"Other"};function initStickyCta(){if(!stickyCta||window.innerWidth>768)return;let e=!1;window.addEventListener("scroll",()=>{!e&&window.scrollY>800&&(stickyCta.style.display="block",e=!0)},{passive:!0})}function initCountdown(){const e=$(".timer");if(!e)return;const t=$("#dd"),o=$("#hh"),n=$("#mm"),a=$("#ss");if(!t||!o||!n||!a)return;const s=e.getAttribute("data-deadline");if(!s)return void[t,o,n,a].forEach(e=>e.textContent="00");const i=new Date(s+"Z").getTime();let d=null;function c(){const e=$("#pioneiros");if(e){e.classList.add("is-closed");const t=e.querySelector(".h2");t&&(t.textContent="Oferta encerrada");const o=e.querySelector(".btn");o&&(o.style.display="none")}[t,o,n,a].forEach(e=>e.textContent="00")}function r(){const e=Date.now(),s=Math.floor((i-e)/1e3);if(s<=0)return c(),void(d&&clearInterval(d));const r=Math.floor(s/86400),l=Math.floor(s%86400/3600),p=Math.floor(s%3600/60),u=s%60;t.textContent=String(r).padStart(2,"0"),o.textContent=String(l).padStart(2,"0"),n.textContent=String(p).padStart(2,"0"),a.textContent=String(u).padStart(2,"0")}r(),d=setInterval(r,1e3)}function initSmoothScroll(){$$('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){const t=this.getAttribute("href");if("#"===t||"#top"===t)return e.preventDefault(),void window.scrollTo({top:0,behavior:"smooth"});try{const o=$(t);if(o){e.preventDefault();const t=o.getBoundingClientRect().top+window.pageYOffset-80;window.scrollTo({top:t,behavior:"smooth"})}}catch(e){}})})}function initPopups(){$$(".exit-popup__overlay, .exit-popup__close, .popup__overlay, .popup__close").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.closest(".exit-popup, .popup");t&&closePopup(t)})}),document.addEventListener("keydown",e=>{"Escape"===e.key&&(closePopup(exitPopup),closePopup(successPopup),closePopup(agencyPopup))}),exitPopup&&(console.log("[Exit-Intent] Inicializado para desktop",{exitPopupShown:exitPopupShown,formSubmitted:formSubmitted,windowWidth:window.innerWidth}),document.documentElement.addEventListener("mouseleave",e=>{console.log("[Exit-Intent] mouseleave detectado",{clientY:e.clientY,exitPopupShown:exitPopupShown,formSubmitted:formSubmitted,windowWidth:window.innerWidth}),e.clientY<0&&!exitPopupShown&&!formSubmitted&&window.innerWidth>768&&(console.log("[Exit-Intent] Condi√ß√µes satisfeitas! Abrindo popup..."),showChatbotPopup(),exitPopupShown=!0)}),document.addEventListener("mouseout",e=>{!e.relatedTarget&&!e.toElement&&!exitPopupShown&&!formSubmitted&&window.innerWidth>768&&(console.log("[Exit-Intent] mouseout detectado (fallback)"),showChatbotPopup(),exitPopupShown=!0)});const e=$("#exitPopupPrimary");e&&e.addEventListener("click",e=>{e.preventDefault(),closePopup(exitPopup);const t=$('a[href="#formulario"]');t&&t.click()});const t=$("#exitPopupSecondary");t&&t.addEventListener("click",e=>{e.preventDefault(),closePopup(exitPopup),openPopup(agencyPopup)})),successPopup&&($("#successPopupSecondaryClose")?.addEventListener("click",()=>closePopup(successPopup))),agencyPopup&&($("#agencyDismiss")?.addEventListener("click",e=>{e.preventDefault(),closePopup(agencyPopup)}))}function initForm(){if(!leadForm)return;leadForm.addEventListener("submit",function(e){e.preventDefault();const t=$("button[type=\"submit\"]",leadForm),o=t?t.innerHTML:"";if(!leadForm.checkValidity())return void leadForm.reportValidity();t&&(t.disabled=!0,t.innerHTML='<i class="ri-loader-4-line"></i> Enviando...');const n=$("#whatsapp",leadForm);n&&(n.value=n.value.replace(/[^\d]/g,"").slice(0,12));const a=$("#instagram",leadForm);a&&(a.value=a.value.replace(/[@\s]/g,"").toLowerCase());const s=$('input[name="usa_automacao"]:checked',leadForm)?.value||"",i=$("#investimento_ferramentas",leadForm)?.value||"",d=$("#desafio_principal",leadForm)?.value?.trim()||"",c={nome:$("#nome",leadForm)?.value||"",email:$("#email",leadForm)?.value||"",whatsapp:$("#whatsapp",leadForm)?.value||"",instagram:$("#instagram",leadForm)?.value||"",origem:$('input[name="origem"]',leadForm)?.value||"chatbot-estetica",usa_automacao:s,investimento_ferramentas:i,desafio_principal:d,timestamp:(new Date).toISOString(),url_origem:location.href,url_referrer:document.referrer||"Direto",tipo_dispositivo:getDeviceType(),navegador:getBrowser(),sistema_operacional:getOS(),resolucao_tela:`${screen.width}x${screen.height}`,idioma_navegador:navigator.language||"N/A"};openPopup(successPopup),formSubmitted=!0;try{window.dataLayer&&window.dataLayer.push({event:"form_submission",form_name:"chatbot-estetica-lead",usa_automacao:s,investimento_ferramentas:i})}catch(e){}const r="https://n8n.alcinomenezesjunior.com/webhook/webhook-lead-capture";let l=!1;try{fetch(r,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify(c),credentials:"omit",keepalive:!0,cache:"no-store"}).catch(e=>{console.error("[AMJ] Erro ao enviar lead para n8n:",e.message)}),l=!0}catch(e){console.error("[AMJ] Erro ao enviar lead para n8n:",e.message)}if(!l)try{navigator.sendBeacon&&(l=navigator.sendBeacon(r,new Blob([JSON.stringify(c)],{type:"text/plain"})))}catch(e){console.error("[AMJ] Erro no sendBeacon:",e.message)}setTimeout(()=>{try{leadForm.reset()}catch(e){}t&&(t.disabled=!1,t.innerHTML=o||"Enviar Candidatura")},800)})}initSmoothScroll(),initForm(),initStickyCta(),initCountdown(),initPopups()}),function(){if("undefined"==typeof window)return;if(((window.innerWidth||1024)<=768)){var e="1"===sessionStorage.getItem("exit_shown"),t=function(){e=!0;try{sessionStorage.setItem("exit_shown","1")}catch(e){}},o=function(e){if(!e)return;if("function"==typeof window.showChatbotPopup)window.showChatbotPopup();else{e.style.display="flex",document.body.style.overflow="hidden"}},n=function(){return!!document.querySelector(".popup.active, .popup.show, .exit-popup[style*=\"display: flex\"]")},a=function(){if(e||n())return;var a=document.getElementById("exitPopupChatbot");a&&(o(a),t())},s=function(e){"complete"===document.readyState||"interactive"===document.readyState?e():document.addEventListener("DOMContentLoaded",e,{once:!0})};s(function(){var e,o=2e4,s=function(){clearTimeout(e),e=setTimeout(a,o)};["touchstart","scroll","keydown","mousemove"].forEach(function(e){window.addEventListener(e,s,{passive:!0})}),s();var i=window.scrollY||0;window.addEventListener("scroll",function(){var e=window.scrollY||0,t=i-e>80,o=e<120;t&&o&&a(),i=e},{passive:!0});try{history.pushState({amjGuard:1},""),window.addEventListener("popstate",function(){if(!e&&!n()){a();try{history.pushState({amjGuard:1},"")}catch(e){}}})}catch(e){}})}}(),function(){const e="https://n8n.alcinomenezesjunior.com/webhook/testar-bot-whatsapp",t=document.getElementById("demo-bot-open"),o=document.getElementById("demo-bot-widget"),n=document.getElementById("demo-bot-close"),a=document.getElementById("demo-bot-messages"),s=document.getElementById("demo-bot-form"),i=document.getElementById("demo-bot-input");if(!t||!o||!a||!s||!i)return;const d="DEMO-"+Date.now();function c(e,t){const o=document.createElement("div");o.className="msg "+("user"===t?"msg-user":"msg-bot"),o.textContent=e,a.appendChild(o),a.scrollTop=a.scrollHeight}t.addEventListener("click",()=>{o.classList.remove("hidden"),o.setAttribute("aria-hidden","false"),i.focus()}),n&&n.addEventListener("click",()=>{o.classList.add("hidden"),o.setAttribute("aria-hidden","true")}),s.addEventListener("submit",async t=>{t.preventDefault();const o=i.value.trim();if(!o)return;c(o,"user"),i.value="",i.focus();try{const t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({whatsapp:d,mensagem:o})});let n;try{n=await t.json()}catch(e){throw new Error("Resposta do servidor n√£o √© JSON v√°lido")}const a=n.reply||n.mensagem||n.message||JSON.stringify(n);c(a,"bot")}catch(e){console.error(e),c("‚ö†Ô∏è Ocorreu um erro na demo: "+(e.message||"Erro desconhecido"),"bot")}})}();
