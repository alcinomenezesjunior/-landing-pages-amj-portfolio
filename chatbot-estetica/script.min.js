document.addEventListener("DOMContentLoaded",()=>{const e=(e,t=document)=>t.querySelector(e),t=(e,t=document)=>[...t.querySelectorAll(e)];let o=!1;const n=new URLSearchParams(window.location.search).has("test-popup");function a(){if(n)return console.log("[Exit-Intent] ðŸ§ª Modo de teste ativo - sessionStorage ignorado"),!1;const e=sessionStorage.getItem("chatbotPopupShown");if(!e)return!1;const t=parseInt(e,10),o=Date.now()-t;return o>18e5?(sessionStorage.removeItem("chatbotPopupShown"),!1):(console.log(`[Exit-Intent] Popup foi mostrado hÃ¡ ${Math.floor(o/6e4)} minutos`),!0)}let i=a();const s=e("#leadForm"),r=e("#sticky-cta"),c=e("#exitPopupChatbot"),d=e("#successPopup"),l=e("#exitPopupAgencia"),u=e=>{e&&(e.style.display="flex",document.body.style.overflow="hidden")},p=e=>{e&&(e.classList.remove("active"),e.classList.remove("show"),e.style.display="none",document.body.style.overflow="")};let h={chatbotShown:a(),agenciaShown:!1},m=null;function w(e){const t=e.querySelectorAll('a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])');if(0===t.length)return;const o=t[0],n=t[t.length-1];o.focus();const a=e=>{"Tab"===e.key&&(e.shiftKey&&document.activeElement===o?(e.preventDefault(),n.focus()):e.shiftKey||document.activeElement!==n||(e.preventDefault(),o.focus()))};e.addEventListener("keydown",a),e._focusTrapHandler=a}function f(){if(console.log("[showChatbotPopup] Chamada recebida",{chatbotShown:h.chatbotShown}),h.chatbotShown)return void console.log("[showChatbotPopup] Bloqueado - popup jÃ¡ foi mostrado nesta sessÃ£o");const e=document.getElementById("exitPopupChatbot");e?(console.log("[showChatbotPopup] Abrindo popup..."),m=document.activeElement,e.classList.add("active"),e.classList.add("show"),e.style.display="flex",document.body.style.overflow="hidden",h.chatbotShown=!0,sessionStorage.setItem("chatbotPopupShown",Date.now().toString()),console.log("[showChatbotPopup] âœ“ Popup aberto com sucesso (expira em 30min)"),w(e)):console.error("[showChatbotPopup] Elemento #exitPopupChatbot nÃ£o encontrado!")}window.closePopup=function(e){const t=document.getElementById(e);t&&(t.classList.remove("active"),t.classList.remove("show"),t.style.display="none",document.body.style.overflow="",function(e){e&&e._focusTrapHandler&&(e.removeEventListener("keydown",e._focusTrapHandler),delete e._focusTrapHandler)}(t),m&&(m.focus(),m=null))},window.showChatbotPopup=f,window.resetPopupState=function(){sessionStorage.removeItem("chatbotPopupShown"),sessionStorage.removeItem("exit_shown"),h.chatbotShown=!1,i=!1,console.log("âœ“ Estado do popup resetado - pode testar novamente")},n&&(console.log("%cðŸ§ª MODO DE TESTE ATIVO","background: #4CAF50; color: white; font-size: 16px; padding: 8px;"),console.log("â†’ O popup vai aparecer sempre, ignorando sessionStorage"),console.log("â†’ Para sair do modo de teste, remova ?test-popup=1 do URL")),window.showAgencyPopup=function(){window.closePopup("exitPopupChatbot");const e=document.getElementById("exitPopupAgencia");e&&(m||(m=document.activeElement),e.classList.add("active"),e.classList.add("show"),e.style.display="flex",document.body.style.overflow="hidden",h.agenciaShown=!0,w(e))},window.scrollToPlans=function(){const e=document.querySelector("#planos");e&&e.scrollIntoView({behavior:"smooth",block:"start"})};window.trackWhatsAppDemo=e=>("undefined"!=typeof gtag&&gtag("event","click",{event_category:"Demo",event_label:"WhatsApp Bot Test",value:1}),!0);const v=()=>{const e=Math.min(window.screen.width,window.innerWidth);return e<600?"mobile":e<1024?"tablet":"desktop"},g=()=>{const e=navigator.userAgent;return/Chrome/i.test(e)&&!/Edge|OPR/i.test(e)?"Chrome":/Safari/i.test(e)&&!/Chrome/i.test(e)?"Safari":/Firefox/i.test(e)?"Firefox":/Edg/i.test(e)?"Edge":"Other"},y=()=>{const e=navigator.userAgent;return/Windows/i.test(e)?"Windows":/Mac OS X/i.test(e)?"macOS":/Android/i.test(e)?"Android":/iPhone|iPad|iOS/i.test(e)?"iOS":"Other"};t('a[href^="#"]').forEach(t=>{t.addEventListener("click",function(t){const o=this.getAttribute("href");if("#"===o||"#top"===o)return t.preventDefault(),void window.scrollTo({top:0,behavior:"smooth"});try{const n=e(o);if(n){t.preventDefault();const e=n.getBoundingClientRect().top+window.pageYOffset-80;window.scrollTo({top:e,behavior:"smooth"})}}catch(e){}})}),s&&s.addEventListener("submit",function(t){t.preventDefault();const n=e('button[type="submit"]',s),a=n?n.innerHTML:"";if(!s.checkValidity())return void s.reportValidity();n&&(n.disabled=!0,n.innerHTML='<i class="ri-loader-4-line"></i> Enviando...');const i=e("#whatsapp",s);i&&(i.value=i.value.replace(/[^\d]/g,"").slice(0,12));const r=e("#instagram",s);r&&(r.value=r.value.replace(/[@\s]/g,"").toLowerCase());const c=e('input[name="usa_automacao"]:checked',s)?.value||"",l=e("#investimento_ferramentas",s)?.value||"",p=e("#desafio_principal",s)?.value?.trim()||"",h={nome:e("#nome",s)?.value||"",email:e("#email",s)?.value||"",whatsapp:e("#whatsapp",s)?.value||"",instagram:e("#instagram",s)?.value||"",origem:e('input[name="origem"]',s)?.value||"chatbot-estetica",usa_automacao:c,investimento_ferramentas:l,desafio_principal:p,timestamp:(new Date).toISOString(),url_origem:location.href,url_referrer:document.referrer||"Direto",tipo_dispositivo:v(),navegador:g(),sistema_operacional:y(),resolucao_tela:`${screen.width}x${screen.height}`,idioma_navegador:navigator.language||"N/A"};u(d),o=!0;try{window.dataLayer&&window.dataLayer.push({event:"form_submission",form_name:"chatbot-estetica-lead",usa_automacao:c,investimento_ferramentas:l})}catch(e){}const m="https://n8n.alcinomenezesjunior.com/webhook/webhook-lead-capture";let w=!1;try{fetch(m,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify(h),credentials:"omit",keepalive:!0,cache:"no-store"}).catch(e=>{console.error("[AMJ] Erro ao enviar lead para n8n:",e.message)}),w=!0}catch(e){console.error("[AMJ] Erro ao enviar lead para n8n:",e.message)}if(!w)try{navigator.sendBeacon&&(w=navigator.sendBeacon(m,new Blob([JSON.stringify(h)],{type:"text/plain"})))}catch(e){console.error("[AMJ] Erro no sendBeacon:",e.message)}setTimeout(()=>{try{s.reset()}catch(e){}n&&(n.disabled=!1,n.innerHTML=a||"Enviar Candidatura")},800)}),function(){if(!r||window.innerWidth>768)return;let e=!1;window.addEventListener("scroll",()=>{!e&&window.scrollY>800&&(r.style.display="block",e=!0)},{passive:!0})}(),function(){const t=e(".timer");if(!t)return;const o=e("#dd"),n=e("#hh"),a=e("#mm"),i=e("#ss");if(!(o&&n&&a&&i))return;const s=t.getAttribute("data-deadline");if(!s)return void[o,n,a,i].forEach(e=>e.textContent="00");const r=new Date(s+"Z").getTime();let c=null;function d(){const t=Date.now(),s=Math.floor((r-t)/1e3);if(s<=0)return function(){const t=e("#pioneiros");if(t){t.classList.add("is-closed");const e=t.querySelector(".h2");e&&(e.textContent="Oferta encerrada");const o=t.querySelector(".btn");o&&(o.style.display="none")}[o,n,a,i].forEach(e=>e.textContent="00")}(),void(c&&clearInterval(c));const d=Math.floor(s/86400),l=Math.floor(s%86400/3600),u=Math.floor(s%3600/60),p=s%60;o.textContent=String(d).padStart(2,"0"),n.textContent=String(l).padStart(2,"0"),a.textContent=String(u).padStart(2,"0"),i.textContent=String(p).padStart(2,"0")}d(),c=setInterval(d,1e3)}(),function(){if(t(".exit-popup__overlay, .exit-popup__close, .popup__overlay, .popup__close").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.closest(".exit-popup, .popup");t&&p(t)})}),document.addEventListener("keydown",e=>{"Escape"===e.key&&(p(c),p(d),p(l))}),c){console.log("[Exit-Intent] Inicializado para desktop",{exitPopupShown:i,formSubmitted:o,windowWidth:window.innerWidth}),document.documentElement.addEventListener("mouseleave",e=>{console.log("[Exit-Intent] mouseleave detectado",{clientY:e.clientY,exitPopupShown:i,formSubmitted:o,windowWidth:window.innerWidth}),e.clientY<0&&!i&&!o&&window.innerWidth>768&&(console.log("[Exit-Intent] CondiÃ§Ãµes satisfeitas! Abrindo popup..."),f(),i=!0)}),document.addEventListener("mouseout",e=>{e.relatedTarget||e.toElement||i||o||!(window.innerWidth>768)||(console.log("[Exit-Intent] mouseout detectado (fallback)"),f(),i=!0)});const t=e("#exitPopupPrimary");t&&t.addEventListener("click",t=>{t.preventDefault(),p(c);const o=e('a[href="#formulario"]');o&&o.click()});const n=e("#exitPopupSecondary");n&&n.addEventListener("click",e=>{e.preventDefault(),p(c),u(l)})}d&&e("#successPopupSecondaryClose")?.addEventListener("click",()=>p(d)),l&&e("#agencyDismiss")?.addEventListener("click",e=>{e.preventDefault(),p(l)})}()}),function(){if("undefined"!=typeof window&&(window.innerWidth||1024)<=768){var e,t="1"===sessionStorage.getItem("exit_shown"),o=function(){return!!document.querySelector('.popup.active, .popup.show, .exit-popup[style*="display: flex"]')},n=function(){if(!t&&!o()){var e=document.getElementById("exitPopupChatbot");e&&(function(e){e&&("function"==typeof window.showChatbotPopup?window.showChatbotPopup():(e.style.display="flex",document.body.style.overflow="hidden"))}(e),function(){t=!0;try{sessionStorage.setItem("exit_shown","1")}catch(e){}}())}};e=function(){var e,a=function(){clearTimeout(e),e=setTimeout(n,2e4)};["touchstart","scroll","keydown","mousemove"].forEach(function(e){window.addEventListener(e,a,{passive:!0})}),a();var i=window.scrollY||0;window.addEventListener("scroll",function(){var e=window.scrollY||0;i-e>80&&e<120&&n(),i=e},{passive:!0});try{history.pushState({amjGuard:1},""),window.addEventListener("popstate",function(){if(!t&&!o()){n();try{history.pushState({amjGuard:1},"")}catch(e){}}})}catch(e){}},"complete"===document.readyState||"interactive"===document.readyState?e():document.addEventListener("DOMContentLoaded",e,{once:!0})}}();
