{
  "name": "1_AMJ_Lead_System_v3.1_COMPLETO_Twilio_CORRIGIDO",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "webhook-lead-capture",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "5ffb30e9-bfc6-497f-9db2-4ebe35ad2628",
      "name": "üéØ Webhook - Captura Lead",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [
        16,
        176
      ],
      "webhookId": "amj-lead-capture-webhook"
    },
    {
      "parameters": {
        "content": "## üì• FASE 1: CAPTURA DE LEADS\n\n**Objetivo:** Receber leads do formul√°rio /chatbot-estetica\n\n**Dados Capturados:**\n- Nome\n- Email\n- Instagram\n- WhatsApp\n- Timestamp\n- Dados t√©cnicos (device, browser, OS, localiza√ß√£o)\n\n**Pr√≥ximo Passo:** Valida√ß√£o e enriquecimento",
        "height": 312,
        "width": 512,
        "color": 4
      },
      "id": "c2c3e83c-f1cf-4b7e-9bb5-ea482bea3f2b",
      "name": "Sticky Note - Fase 1",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -272,
        -144
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "multiplex",
        "options": {}
      },
      "id": "b6d706b9-c5f2-4862-86e8-6ffb1b814111",
      "name": "üîÑ Merge - Dados Webhook",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [
        240,
        160
      ]
    },
    {
      "parameters": {
        "jsCode": "// n8n Code node ‚Äì Validar e formatar lead para Google Sheets (multi-LP)\n\nconst items = $input.all();\nconst output = [];\n\nfunction pad2(n) {\n  return n.toString().padStart(2, '0');\n}\n\nfunction formatDateTime(date) {\n  // Ex.: 2025-11-19 19h43\n  return (\n    `${date.getFullYear()}-${pad2(date.getMonth() + 1)}-${pad2(date.getDate())} ` +\n    `${pad2(date.getHours())}h${pad2(date.getMinutes())}`\n  );\n}\n\nfunction titleCaseName(str) {\n  if (!str) return '';\n  return str\n    .toString()\n    .trim()\n    .toLowerCase()\n    .split(' ')\n    .filter(Boolean)\n    .map(p => p.charAt(0).toUpperCase() + p.slice(1))\n    .join(' ');\n}\n\nfunction capitalizeFirst(str) {\n  if (!str) return '';\n  const s = str.toString().trim();\n  if (!s) return '';\n  return s.charAt(0).toUpperCase() + s.slice(1);\n}\n\n// para garantir que nunca vai espa√ßo antes do \"=\" do HYPERLINK\nfunction buildWhatsappFormula(numero, nome) {\n  if (!numero) return '';\n  const safeNome = nome || 'WhatsApp';\n  // usa ; como separador (pt-PT). Se teu ficheiro estiver em locale EN\n  // podes trocar por \",\" aqui.\n  return `=HYPERLINK(\"https://wa.me/${numero}\"; \"üí¨ ${safeNome}\")`;\n}\n\nfor (const item of items) {\n  const now = new Date();\n  const nowStr = formatDateTime(now);\n\n  // 1) Ler payload do webhook (pode vir em item.json.body ou direto em item.json)\n  let raw = item.json && item.json.body !== undefined ? item.json.body : item.json || {};\n  let lead;\n\n  if (typeof raw === 'string') {\n    try {\n      lead = JSON.parse(raw);\n    } catch (e) {\n      lead = {};\n    }\n  } else if (raw && typeof raw === 'object') {\n    lead = { ...raw };\n  } else {\n    lead = {};\n  }\n\n  // =========================\n  // CAMPOS B√ÅSICOS\n  // =========================\n\n  // Nome em Title Case\n  const nomeFormatado = titleCaseName(lead.nome || '');\n  lead.nome = nomeFormatado;\n\n  // Email\n  if (lead.email) {\n    lead.email = lead.email.toString().trim().toLowerCase();\n  }\n\n  // Instagram com @\n  if (lead.instagram) {\n    let ig = lead.instagram.toString().trim();\n    ig = ig.replace(/^@+/, '');\n    lead.instagram = ig ? '@' + ig : '';\n  }\n\n  // WhatsApp + link HYPERLINK\n  if (lead.whatsapp || lead.telefone) {\n    let w = (lead.whatsapp || lead.telefone).toString().replace(/\\D/g, '');\n    if (w && !w.startsWith('351')) {\n      w = '351' + w;\n    }\n    lead.whatsapp = w || '';\n\n    if (w) {\n      // ‚û°Ô∏è CORRE√á√ÉO APLICADA AQUI: \n      // Usamos .replace(/^\\s+/, '') para remover qualquer espa√ßo em branco (inclusive n√£o-breaking space) no in√≠cio\n      // O .trim() original j√° estava ok, mas esta regex √© mais robusta contra caracteres invis√≠veis.\n      lead.linkWhatsapp = buildWhatsappFormula(w, nomeFormatado).replace(/^\\s+/, '');\n    } else {\n      lead.linkWhatsapp = '';\n    }\n  } else {\n    lead.whatsapp = '';\n    lead.linkWhatsapp = '';\n  }\n\n  // Idioma\n  if (lead.idioma_navegador) {\n    lead.idioma = lead.idioma_navegador.toString().trim();\n  } else if (!lead.idioma) {\n    lead.idioma = 'pt-PT';\n  }\n\n  // =========================\n  // ORIGEM / P√ÅGINA / DEVICE\n  // =========================\n\n  const origemCodigo =\n    (lead.origem || lead.origemCodigo || 'LP_Chatbot_Estetica').toString().trim();\n  const origemKey = origemCodigo.toLowerCase();\n\n  const paginaOrigem =\n    (lead.url_origem || lead.paginaOrigem ||\n      'https://www.alcinomenezesjunior.com').toString().trim();\n\n  lead.origemCodigo = origemCodigo;\n  lead.paginaOrigem = paginaOrigem;\n\n  const tipoDisp = (lead.tipo_dispositivo || '').toString().trim().toLowerCase();\n  let dispositivo = 'Desktop';\n  if (tipoDisp === 'mobile') dispositivo = 'Mobile';\n  else if (tipoDisp === 'desktop') dispositivo = 'Desktop';\n\n  const navegador =\n    (lead.navegador || lead.browser || '').toString().trim() || 'Outro';\n\n  const os =\n    (lead.sistema_operacional || lead.os || '').toString().trim() || 'Outro';\n\n  lead.dispositivo = dispositivo;\n  lead.navegador = navegador;\n  lead.os = os;\n\n  // Geo / referrer\n  lead.pais = (lead.country || lead.pais || 'Portugal').toString().trim();\n  lead.distrito = (lead.region || lead.distrito || '').toString().trim();\n  lead.cidade = (lead.city || lead.cidade || '').toString().trim();\n  lead.provedor = (lead.isp || lead.provedor || '').toString().trim();\n  lead.referrer =\n    (lead.url_referrer || lead.referrer || 'Direto').toString().trim();\n\n  // =========================\n  // FORMUL√ÅRIO AVAN√áADO\n  // =========================\n\n  const usaAutomacaoRaw =\n    (lead.usa_automacao || lead.usaAutomacao || '').toString().trim().toLowerCase();\n\n  const investimentoBruto =\n    (lead.investimento_ferramentas || lead.investimentoFerramentas || '')\n      .toString()\n      .trim();\n\n  const desafioBruto =\n    (lead.desafio_principal || lead.desafioPrincipal || '').toString().trim();\n\n  const usaAutomacaoTexto =\n    usaAutomacaoRaw === 'sim' ? 'Sim'\n      : (usaAutomacaoRaw === 'nao' || usaAutomacaoRaw === 'n√£o') ? 'N√£o'\n      : 'n√£o informou';\n\n  // converte para n√∫mero (para poderes formatar como ‚Ç¨ no Sheets)\n  let investimentoNumero = 0;\n  if (investimentoBruto) {\n    const normalizado = investimentoBruto\n      .replace(/[^\\d,.-]/g, '')   // tira s√≠mbolos\n      .replace(',', '.');         // v√≠rgula -> ponto\n    const num = parseFloat(normalizado);\n    if (!isNaN(num)) investimentoNumero = num;\n  }\n\n  // Desafio principal com 1¬™ letra mai√∫scula\n  const desafioPrincipal = capitalizeFirst(desafioBruto);\n\n  // guarda originais\n  lead.usa_automacao = usaAutomacaoRaw;\n  lead.investimento_ferramentas = investimentoBruto;\n  lead.desafio_principal = desafioPrincipal; // <-- j√° capitalizado\n\n  // e as vers√µes \"bonitas\"\n  lead.usaAutomacao = usaAutomacaoRaw;\n  lead.investimentoFerramentas = investimentoNumero; // n√∫mero\n  lead.desafioPrincipal = desafioPrincipal;          // 1¬™ letra mai√∫scula\n\n  // =========================\n  // INTERESSE / SERVI√áO / ORIGEM LABEL\n  // =========================\n\n  let interesse =\n    (lead.interesse || '').toString().trim() || desafioPrincipal;\n\n  let servico = (lead.servico || '').toString().trim();\n  let origemLabel = (lead.origemLabel || '').toString().trim();\n\n  if (!servico || !origemLabel) {\n    if (origemKey === 'lp_chatbot_estetica') {\n      servico = servico || 'Chatbot para Est√∫dios de Est√©tica';\n      origemLabel = origemLabel || 'Landing Page /chatbot-estetica';\n    } else if (origemKey === 'lp_agencia') {\n      servico = servico || 'Gest√£o de Tr√°fego & Automa√ß√£o para Empresas';\n      origemLabel = origemLabel || 'Landing Page /agencia';\n    } else if (origemKey === 'lp_agentes_ia') {\n      servico = servico || 'Agentes de IA para Atendimento & Suporte';\n      origemLabel = origemLabel || 'Landing Page /agentes-ia';\n    } else if (origemKey === 'lp_pme') {\n      servico = servico || 'Marketing & Automa√ß√£o para PME L√≠der/Excel√™ncia';\n      origemLabel = origemLabel || 'Landing Page /pme';\n    } else {\n      servico = servico || 'Lead captado via landing page';\n      origemLabel = origemLabel || 'Landing Page (gen√©rica)';\n    }\n  }\n\n  lead.interesse = interesse;\n  lead.servico = servico;\n  lead.origem = origemLabel;\n\n  // =========================\n  // NOTAS / STATUS / CONTROLO\n  // =========================\n\n  const investimentoTexto = investimentoBruto || 'n√£o informou';\n\n  const notasEnriquecimento =\n    `Usa automa√ß√£o: ${usaAutomacaoTexto} | ` +\n    `Investimento em ferramentas: ${investimentoTexto} | ` +\n    `Desafio principal: ${desafioPrincipal || 'n√£o informou'}`;\n\n  lead.notasEnriquecimento = lead.notasEnriquecimento || notasEnriquecimento;\n\n  lead.timestamp = nowStr;\n  lead.status = lead.status || 'Novo';\n  lead.dataContacto = lead.dataContacto || nowStr;\n  lead.meioContacto =\n    lead.meioContacto ||\n    `Formul√°rio ‚Äì LP ${origemCodigo.replace(/^lp_/i, '').replace(/_/g, ' ')}`;\n  lead.ultimaInteracao = lead.ultimaInteracao || nowStr;\n  lead.leadScore = lead.leadScore || 0;\n  lead.emailEnviado = lead.emailEnviado || 'N√£o';\n  lead.whatsappEnviado = lead.whatsappEnviado || 'N√£o';\n\n  if (!lead.pais) lead.pais = 'Portugal';\n  if (!lead.referrer) lead.referrer = 'Direto';\n\n  output.push({ json: lead });\n}\n\nreturn output;"
      },
      "id": "2d1d7481-9541-4c4d-b4e4-7ee323dd0828",
      "name": "‚öôÔ∏è Code - Validar e Formatar",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        432,
        160
      ]
    },
    {
      "parameters": {
        "content": "## üîç FASE 2: ENRIQUECIMENTO COM IA\n\n**Objetivo:** Analisar e enriquecer dados do lead\n\n**Agente IA:**\n- Modelo: Perplexity Sonar\n- An√°lise de perfil\n- Identifica√ß√£o de necessidades\n- Pesquisa de mercado local\n\n**Output:** Notas estruturadas sobre o lead",
        "height": 296,
        "width": 560,
        "color": 5
      },
      "id": "557283b4-623f-41be-86f0-080474a1bca2",
      "name": "Sticky Note - Fase 2",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        368,
        -144
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.perplexity.ai/chat/completions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"llama-3.1-sonar-large-128k-online\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Voc√™ √© um analista de mercado especializado em cl√≠nicas de est√©tica em Portugal. Use suas capacidades de pesquisa online para encontrar informa√ß√µes atualizadas sobre o lead e o mercado.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"Analise este lead de cl√≠nica de est√©tica e fa√ßa uma pesquisa completa:\\n\\n**DADOS DO LEAD:**\\nNome: {{ $json.nome }}\\nEmail: {{ $json.email }}\\nInstagram: {{ $json.instagram }}\\nWhatsApp: {{ $json.whatsapp }}\\nCidade: {{ $json.cidade }}, {{ $json.distrito }}\\nInteresse: {{ $json.interesse }}\\nServi√ßo: {{ $json.servico }}\\nDispositivo: {{ $json.dispositivo }}\\n\\n**TAREFAS DE PESQUISA:**\\n\\n1. **Pesquise sobre a pessoa/cl√≠nica:**\\n   - Se o Instagram foi fornecido, tente encontrar informa√ß√µes sobre o perfil\\n   - Tipo de neg√≥cio (cl√≠nica estabelecida, profissional solo, novo neg√≥cio)\\n   - Presen√ßa digital existente\\n\\n2. **Contexto do mercado local:**\\n   - Pesquise sobre o mercado de est√©tica em {{ $json.cidade }}\\n   - Concorr√™ncia na regi√£o\\n   - Tend√™ncias atuais (2024-2025)\\n\\n3. **An√°lise de necessidades:**\\n   - Com base no interesse manifestado: {{ $json.interesse }}\\n   - Dores t√≠picas de cl√≠nicas deste porte\\n   - Oportunidades de automa√ß√£o espec√≠ficas\\n\\n4. **Recomenda√ß√µes t√°ticas:**\\n   - Qual pacote AMJ seria mais adequado? (Essencial ‚Ç¨690+‚Ç¨179/m√™s, Pro ‚Ç¨990+‚Ç¨279/m√™s, Enterprise ‚Ç¨1490+‚Ç¨390/m√™s)\\n   - Pontos de dor priorit√°rios a abordar\\n   - √Çngulo de abordagem recomendado\\n\\n**FORMATO DE RESPOSTA:**\\nForne√ßa uma an√°lise estruturada em portugu√™s de Portugal (m√°ximo 600 palavras) com:\\n\\n### üìä Perfil do Lead\\n[Descri√ß√£o do neg√≥cio/profissional]\\n\\n### üéØ Necessidades Identificadas\\n[Lista de 3-4 necessidades principais]\\n\\n### üí° Oportunidades de Automa√ß√£o\\n[Como AMJ pode ajudar especificamente]\\n\\n### üéÅ Pacote Recomendado\\n[Essencial/Pro/Enterprise e porqu√™]\\n\\n### üìù Abordagem Sugerida\\n[Como iniciar o contato - tom, √¢ngulo, pontos-chave]\\n\\n**IMPORTANTE:**\\n- Use informa√ß√µes reais encontradas online quando dispon√≠vel\\n- Se n√£o encontrar informa√ß√µes espec√≠ficas, fa√ßa infer√™ncias baseadas nos dados fornecidos e no mercado geral\\n- Foque em insights ACION√ÅVEIS para vendas\\n- Seja conciso mas completo\"\n    }\n  ],\n  \"temperature\": 0.6,\n  \"max_tokens\": 1000\n}",
        "options": {}
      },
      "id": "957396ae-8f6c-4a4e-9846-c9062487171b",
      "name": "üîç Perplexity - Enriquecimento Lead",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        640,
        160
      ],
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Extrai an√°lise do Perplexity e formata\nconst items = $input.all();\nconst output = [];\n\nfor (const item of items) {\n  let perplexityResponse;\n  \n  // Tenta extrair a resposta do Perplexity\n  try {\n    if (item.json.choices && item.json.choices[0]) {\n      perplexityResponse = item.json.choices[0].message.content;\n    } else if (item.json.message && item.json.message.content) {\n      perplexityResponse = item.json.message.content;\n    } else {\n      perplexityResponse = 'An√°lise n√£o dispon√≠vel - lead capturado para an√°lise manual.';\n    }\n  } catch (error) {\n    perplexityResponse = 'Erro ao processar an√°lise Perplexity - lead capturado para revis√£o.';\n  }\n  \n  // Pega dados do lead do input anterior\n  const leadData = $('‚öôÔ∏è Code - Validar e Formatar').first().json;\n  \n  output.push({\n    json: {\n      ...leadData,\n      notasEnriquecimento: perplexityResponse\n    }\n  });\n}\n\nreturn output;"
      },
      "id": "3d006a71-ffbb-47a1-b5df-c97ff50547f3",
      "name": "‚öôÔ∏è Code - Parse Perplexity",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        832,
        160
      ]
    },
    {
      "parameters": {
        "content": "## üéØ FASE 3: LEAD SCORING\n\n**Objetivo:** Calcular pontua√ß√£o do lead\n\n**Agente IA:**\n- Modelo: GPT-4 Turbo\n- Crit√©rios: Dados, Qualidade, Geografia, Interesse, Comportamento, An√°lise Perplexity\n\n**Classifica√ß√£o:**\n- 80-100: Quente üî•\n- 50-79: Morno üü°\n- 0-49: Frio ‚ùÑÔ∏è",
        "height": 304,
        "width": 352,
        "color": 6
      },
      "id": "879c0be5-1c6a-43c6-9307-20d1da7cb19e",
      "name": "Sticky Note - Fase 3",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        960,
        -144
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gpt-4-turbo-preview\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Voc√™ √© um especialista em lead scoring para o mercado B2B de automa√ß√£o em Portugal. Analise leads de forma objetiva e atribua pontua√ß√µes baseadas em dados concretos.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": \"Calcule o Lead Score deste potencial cliente de automa√ß√£o WhatsApp:\\n\\n**DADOS DO LEAD:**\\nNome: {{ $json.nome }}\\nEmail: {{ $json.email }}\\nInstagram: {{ $json.instagram }}\\nWhatsApp: {{ $json.whatsapp }}\\nCidade: {{ $json.cidade }}, {{ $json.distrito }}\\nDispositivo: {{ $json.dispositivo }}\\nNavegador: {{ $json.navegador }}\\nInteresse: {{ $json.interesse }}\\nServi√ßo: {{ $json.servico }}\\nReferrer: {{ $json.referrer }}\\n\\n**AN√ÅLISE PERPLEXITY:**\\n{{ $json.notasEnriquecimento }}\\n\\n**CRIT√âRIOS DE PONTUA√á√ÉO (Total: 100 pontos):**\\n\\n**1. COMPLETUDE DE DADOS (20 pontos):**\\n- Nome completo v√°lido: +5pts\\n- Email profissional/v√°lido: +5pts\\n- WhatsApp no formato correto: +5pts\\n- Instagram fornecido: +5pts\\n\\n**2. QUALIDADE DO CONTATO (25 pontos):**\\n- Instagram ativo/profissional: +10pts\\n- WhatsApp validado: +10pts\\n- Email corporativo (n√£o Gmail/Hotmail): +5pts\\n\\n**3. CONTEXTO GEOGR√ÅFICO (15 pontos):**\\n- Grande centro urbano (Lisboa, Porto, Braga, Coimbra): +10pts\\n- Cidade m√©dia: +7pts\\n- √Årea tur√≠stica (Algarve, Madeira): +5pts\\n\\n**4. INTERESSE E ESPECIFICIDADE (20 pontos):**\\n- Interesse muito espec√≠fico/detalhado: +15pts\\n- Servi√ßo claramente definido: +10pts\\n- Mencionou problema/dor espec√≠fica: +5pts\\n\\n**5. COMPORTAMENTO DIGITAL (10 pontos):**\\n- Acesso mobile (t√≠pico de empreendedor ativo): +5pts\\n- Tr√°fego referenciado (n√£o direto): +5pts\\n\\n**6. AN√ÅLISE PERPLEXITY (10 pontos):**\\n- Alta urg√™ncia detectada: +5pts\\n- Presen√ßa digital estabelecida: +3pts\\n- Mercado aquecido na regi√£o: +2pts\\n\\n**SUA TAREFA:**\\nRetorne APENAS um objeto JSON v√°lido (sem markdown, sem explica√ß√µes) com esta estrutura EXATA:\\n\\n{\\n  \\\"leadScore\\\": [n√∫mero de 0-100],\\n  \\\"classificacao\\\": \\\"Quente üî•\\\" ou \\\"Morno üü°\\\" ou \\\"Frio ‚ùÑÔ∏è\\\",\\n  \\\"probabilidadeConversao\\\": \\\"XX-YY%\\\",\\n  \\\"pontosPorCategoria\\\": {\\n    \\\"completudeDados\\\": [0-20],\\n    \\\"qualidadeContato\\\": [0-25],\\n    \\\"contextoGeografico\\\": [0-15],\\n    \\\"interesseEspecificidade\\\": [0-20],\\n    \\\"comportamentoDigital\\\": [0-10],\\n    \\\"analisePerplexity\\\": [0-10]\\n  },\\n  \\\"justificativa\\\": \\\"Breve explica√ß√£o de 2-3 linhas do score\\\",\\n  \\\"proximosPassos\\\": \\\"Recomenda√ß√£o t√°tica de abordagem\\\"\\n}\\n\\n**CLASSIFICA√á√ÉO:**\\n- 80-100 pontos = Quente üî• (Probabilidade: 70-90%)\\n- 50-79 pontos = Morno üü° (Probabilidade: 40-70%)\\n- 0-49 pontos = Frio ‚ùÑÔ∏è (Probabilidade: 10-40%)\\n\\n**IMPORTANTE:**\\n- Seja rigoroso mas justo\\n- Baseie-se em DADOS, n√£o em suposi√ß√µes\\n- JSON deve ser v√°lido e parse√°vel\\n- N√ÉO adicione markdown (```json)\\n- Retorne APENAS o JSON\"\n    }\n  ],\n  \"temperature\": 0.3,\n  \"max_tokens\": 500\n}",
        "options": {}
      },
      "id": "145e2b58-a18b-47bf-8437-2e78148006df",
      "name": "üéØ GPT-4 - Lead Scoring",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1040,
        160
      ],
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Parse Lead Score do GPT-4\nconst items = $input.all();\nconst output = [];\n\nfor (const item of items) {\n  let scoringData;\n  \n  try {\n    const gpt4Response = item.json.choices[0].message.content;\n    \n    // Remove markdown se houver\n    let cleanJson = gpt4Response.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n    \n    // Parse JSON\n    scoringData = JSON.parse(cleanJson);\n  } catch (error) {\n    // Fallback se JSON inv√°lido\n    scoringData = {\n      leadScore: 50,\n      classificacao: 'Morno üü°',\n      probabilidadeConversao: '40-70%',\n      justificativa: 'Score calculado com dados parciais - an√°lise manual recomendada',\n      proximosPassos: 'Revisar manualmente e ajustar abordagem'\n    };\n  }\n  \n  // Pega dados anteriores do lead\n  const leadData = $('‚öôÔ∏è Code - Parse Perplexity').first().json;\n  \n  // Monta observa√ß√µes detalhadas\n  const observacoes = `Score: ${scoringData.leadScore}/100 | ${scoringData.classificacao} | ${scoringData.justificativa}`;\n  \n  output.push({\n    json: {\n      ...leadData,\n      leadScore: scoringData.leadScore,\n      status: scoringData.classificacao,\n      probabilidadeConversao: scoringData.probabilidadeConversao,\n      observacoes: observacoes\n    }\n  });\n}\n\nreturn output;"
      },
      "id": "cad41ece-f7ef-47e6-8add-7d24ea360389",
      "name": "‚öôÔ∏è Code - Parse Lead Score",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1232,
        160
      ]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1YZ6oN42skTdjYT9uVAuLHXwAhlgxqe9gphygHtXuxzI",
          "mode": "list",
          "cachedResultName": "Leads AMJ",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1YZ6oN42skTdjYT9uVAuLHXwAhlgxqe9gphygHtXuxzI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "leads",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1YZ6oN42skTdjYT9uVAuLHXwAhlgxqe9gphygHtXuxzI/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "timestamp": "= {{ $json.timestamp }}",
            "nome": "= {{ $json.nome }}",
            "email": "= {{ $json.email }}",
            "instagram": "= {{ $json.instagram }}",
            "whatsapp": "= {{ $json.whatsapp }}",
            "status": "= {{ $json.status }}",
            "dataContacto": "= {{ $json.dataContacto }}",
            "meioContacto": "= {{ $json.meioContacto }}",
            "notasEnriquecimento": "= {{ $json.notasEnriquecimento }}",
            "leadScore": "= {{ $json.leadScore }}",
            "emailEnviado": "= {{ $json.emailEnviado }}",
            "whatsappEnviado": "= {{ $json.whatsappEnviado }}",
            "ultimaInteracao": "= {{ $json.ultimaInteracao }}",
            "interesse": "= {{ $json.interesse }}",
            "servico": "= {{ $json.servico }}",
            "origem": "= {{ $json.origem }}",
            "valorProposta": "= ",
            "probabilidadeConversao": "= {{ $json.probabilidadeConversao }}",
            "observacoes": "= {{ $json.observacoes }}",
            "dispositivo": "= {{ $json.dispositivo }}",
            "navegador": "= {{ $json.navegador }}",
            "os": "={{ $json.os }}",
            "pais": "= {{ $json.pais }}",
            "distrito": "= {{ $json.distrito }}",
            "cidade": "= {{ $json.cidade }}",
            "provedor": "= {{ $json.provedor }}",
            "referrer": "= {{ $json.referrer }}",
            "idioma": "={{ $json.idioma }}",
            "origemCodigo": "= {{ $json.origemCodigo }}",
            "paginaOrigem": "= {{ $json.paginaOrigem }}",
            "linkWhatsapp": "={{ $json.linkWhatsapp }}",
            "usaAutomacao": "= {{ $json.usa_automacao }}",
            "investimentoFerramentas": "= {{ $json.investimento_ferramentas }}",
            "desafioPrincipal": "={{ $json.desafio_principal }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nome",
              "displayName": "nome",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "instagram",
              "displayName": "instagram",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "whatsapp",
              "displayName": "whatsapp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "dataContacto",
              "displayName": "dataContacto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "meioContacto",
              "displayName": "meioContacto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "notasEnriquecimento",
              "displayName": "notasEnriquecimento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "leadScore",
              "displayName": "leadScore",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "emailEnviado",
              "displayName": "emailEnviado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "whatsappEnviado",
              "displayName": "whatsappEnviado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ultimaInteracao",
              "displayName": "ultimaInteracao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "interesse",
              "displayName": "interesse",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "servico",
              "displayName": "servico",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "origem",
              "displayName": "origem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "valorProposta",
              "displayName": "valorProposta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "probabilidadeConversao",
              "displayName": "probabilidadeConversao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "observacoes",
              "displayName": "observacoes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "linkWhatsapp",
              "displayName": "linkWhatsapp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "dispositivo",
              "displayName": "dispositivo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "navegador",
              "displayName": "navegador",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "os",
              "displayName": "os",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "pais",
              "displayName": "pais",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "distrito",
              "displayName": "distrito",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "cidade",
              "displayName": "cidade",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "provedor",
              "displayName": "provedor",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "referrer",
              "displayName": "referrer",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "idioma",
              "displayName": "idioma",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "origemCodigo",
              "displayName": "origemCodigo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "paginaOrigem",
              "displayName": "paginaOrigem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "usaAutomacao",
              "displayName": "usaAutomacao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "investimentoFerramentas",
              "displayName": "investimentoFerramentas",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "desafioPrincipal",
              "displayName": "desafioPrincipal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "cellFormat": "USER_ENTERED"
        }
      },
      "id": "83c905de-8859-4fa9-94cc-4876a9e71509",
      "name": "üìä Google Sheets - Salvar Lead",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [
        1440,
        160
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mIkSlt9IkIuDsP58",
          "name": "Google Sheets - Leads"
        }
      }
    },
    {
      "parameters": {
        "content": "## üìß FASE 4: EMAIL AUTOM√ÅTICO\n\n**Objetivo:** Enviar primeiro email personalizado\n\n**Processo:**\n1. IA (Claude) gera email customizado\n2. Notifica√ß√£o Telegram para aprova√ß√£o\n3. Aguarda resposta humana\n4. Envia se aprovado\n\n**Timing:** Imediato ap√≥s scoring\n\n**Pr√≥ximo:** Email 2 em 24h",
        "height": 300,
        "width": 448,
        "color": 3
      },
      "id": "ac260d18-68ef-4500-b08c-d939734b744c",
      "name": "Sticky Note - Fase 4",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1504,
        -144
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "[https://api.anthropic.com/v1/messages](https://api.anthropic.com/v1/messages)",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "anthropic-version",
              "value": "2023-06-01"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"claude-sonnet-4-20250514\",\n  \"max_tokens\": 2000,\n  \"temperature\": 0.8,\n  \"messages\": [\n    {\n      \"role\": \"user\",\n      \"content\": \"Voc√™ √© um copywriter portugu√™s especializado em emails de vendas B2B para cl√≠nicas de est√©tica. Seu estilo √© profissional mas caloroso, consultivo e emp√°tico.\\n\\n**CONTEXTO DO NEG√ìCIO AMJ:**\\nVendemos automa√ß√£o de WhatsApp para cl√≠nicas de est√©tica em Portugal. Nosso foco √© resolver problemas de comunica√ß√£o, perda de clientes por demora nas respostas, e aumentar convers√µes atrav√©s de automa√ß√£o inteligente com IA.\\n\\n**PACOTES AMJ:**\\n- Essencial: ‚Ç¨690 setup + ‚Ç¨179/m√™s\\n- Pro: ‚Ç¨990 setup + ‚Ç¨279/m√™s\\n- Enterprise: ‚Ç¨1490 setup + ‚Ç¨390/m√™s\\n\\n**DADOS DO LEAD:**\\nNome: {{ $json.nome }}\\nEmail: {{ $json.email }}\\nCidade: {{ $json.cidade }}, {{ $json.distrito }}\\nInstagram: {{ $json.instagram }}\\nInteresse manifestado: {{ $json.interesse }}\\nServi√ßo espec√≠fico: {{ $json.servico }}\\nLead Score: {{ $json.leadScore }}/100\\nClassifica√ß√£o: {{ $json.status }}\\n\\n**AN√ÅLISE COMPLETA DO LEAD (Perplexity):**\\n{{ $json.notasEnriquecimento }}\\n\\n**AN√ÅLISE DE SCORING (GPT-4):**\\n{{ $json.observacoes }}\\n\\n---\\n\\n**SUA MISS√ÉO:**\\nCrie um email de boas-vindas ALTAMENTE PERSONALIZADO que soe genuinamente escrito por um humano portugu√™s. Este √© o PRIMEIRO contato - deve construir confian√ßa antes de vender.\\n\\n**ESTRUTURA OBRIGAT√ìRIA:**\\n\\n**ASSUNTO:** (Crie 1 op√ß√£o criativa, personalizada com nome e cidade)\\nExemplo: \\\"{{ $json.nome }}, como anda a gest√£o de clientes em {{ $json.cidade }}?\\\"\\n\\n**CORPO DO EMAIL:**\\n\\n**1. ABERTURA ULTRA-PERSONALIZADA (3-4 linhas)**\\n- Cumprimento pelo nome\\n- Refer√™ncia ESPEC√çFICA √† cidade ou regi√£o\\n- Conex√£o com o interesse manifestado: {{ $json.interesse }}\\n- Tom: Como se conhecesse a pessoa h√° algum tempo\\n\\n**2. EMPATIA COM DESAFIO ESPEC√çFICO (4-5 linhas)**\\n- Identifique UMA dor espec√≠fica baseada na an√°lise Perplexity\\n- Use dados reais: 'Cl√≠nicas em Portugal perdem 30-40% dos leads por resposta lenta no WhatsApp'\\n- Conte brevemente uma hist√≥ria de outra cl√≠nica similar (sem nomes)\\n- Crie sensa√ß√£o de 'ele entende mesmo o meu problema'\\n\\n**3. CURIOSIDADE SEM PITCH (3-4 linhas)**\\n- Mencione que trabalha com cl√≠nicas de est√©tica em Portugal\\n- Foco em resultados (n√£o em produto): 'Ajudo cl√≠nicas a responder todos os WhatsApp em menos de 2 minutos, 24/7'\\n- N√ÉO mencionar pre√ßos ou pacotes ainda\\n- Plantar semente de solu√ß√£o\\n\\n**4. SOCIAL PROOF SUTIL (2-3 linhas)**\\n- Mencione sucesso com cl√≠nicas portuguesas (sem nomes espec√≠ficos)\\n- N√∫mero concreto: 'Cl√≠nicas reduziram 60% do tempo gasto em WhatsApp'\\n- Deve soar factual, n√£o comercial\\n\\n**5. CALL-TO-ACTION SUAVE (2-3 linhas)**\\n- Ofere√ßa demonstra√ß√£o gratuita de 15min\\n- Frase: 'Quer ver como funcionaria na sua cl√≠nica em {{ $json.cidade }}?'\\n- Link: [PLACEHOLDER_CALENDAR_LINK]\\n- Alternativa: 'Responda este email com 'SIM' e agendamos'\\n\\n**6. ASSINATURA PROFISSIONAL MAS CALOROSA**\\nUm abra√ßo,\\nAlcino Menezes J√∫nior\\nFundador da AMJ Automa√ß√£o & IA\\nEspecialista em Automa√ß√£o para Cl√≠nicas de Est√©tica\\nWhatsApp: +351 926 698 959\\nalcinomenezesjunior.com\\n\\n**P.S.** [Adicione um P.S. relevante baseado na an√°lise do lead - pode ser uma curiosidade, estat√≠stica ou pergunta provocativa]\\n\\n---\\n\\n**DIRETRIZES DE TOM E ESTILO:**\\n\\n‚úÖ **FAZER:**\\n- Usar portugu√™s de Portugal natural (voc√™/sua, n√£o tu/tua)\\n- Parecer escrito por humano, n√£o por IA\\n- Personalizar com detalhes espec√≠ficos do lead\\n- Ser consultivo, emp√°tico e profissional\\n- M√°ximo 450 palavras\\n- Par√°grafos curtos (2-4 linhas)\\n- Uma emo√ß√£o: interesse genu√≠no em ajudar\\n\\n‚ùå **N√ÉO FAZER:**\\n- Linguagem muito formal/corporativa\\n- Paredes de texto\\n- Excesso de adjetivos\\n- Emojis no corpo (s√≥ no assunto se fizer sentido)\\n- Mencionar pre√ßos neste primeiro email\\n- Frases feitas ou clich√™s\\n- Tom de vendedor desesperado\\n\\n**IMPORTANTE:**\\n- Este email ser√° enviado ap√≥s aprova√ß√£o humana via Telegram\\n- Deve ter taxa de resposta alta (>15%)\\n- Lead deve pensar: 'Esta pessoa entende o meu neg√≥cio'\\n- Foco em VALOR e CONFIAN√áA, n√£o em venda imediata\\n\\n---\\n\\n**OUTPUT ESPERADO:**\\nForne√ßa o email completo (assunto + corpo) pronto para enviar. N√£o adicione explica√ß√µes, coment√°rios ou markdown. Apenas o email puro em texto.\\n\\nCOMECE AGORA:\"\n    }\n  ]\n}",
        "options": {}
      },
      "id": "e77a8238-c047-4eb4-b65a-ee4bce0db8f9",
      "name": "‚úâÔ∏è Claude - Gerar Email 1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1632,
        160
      ],
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Parse email gerado pelo Claude\nconst items = $input.all();\nconst output = [];\n\nfor (const item of items) {\n  let emailContent;\n  \n  try {\n    // Claude retorna no formato diferente do OpenAI\n    emailContent = item.json.content[0].text;\n  } catch (error) {\n    emailContent = 'Erro ao gerar email - revis√£o manual necess√°ria.';\n  }\n  \n  // Separa assunto do corpo\n  const lines = emailContent.split('\\n').filter(line => line.trim().length > 0);\n  let subject = '';\n  let body = '';\n  let foundBody = false;\n  \n  for (let i = 0; i < lines.length; i++) {\n    const line = lines[i];\n    \n    if (line.toLowerCase().includes('assunto:') && !subject) {\n      subject = line.replace(/.*assunto:/i, '').trim();\n    } else if (line.toLowerCase().includes('corpo do email:') || line.toLowerCase().includes('corpo:')) {\n      foundBody = true;\n      continue;\n    } else if (foundBody && line.trim().length > 0) {\n      body += line + '\\n';\n    } else if (!subject && !foundBody && i === 0) {\n      // Primeira linha pode ser o assunto\n      subject = line.trim();\n    } else if (i > 0 && !foundBody) {\n      body += line + '\\n';\n    }\n  }\n  \n  // Fallback se n√£o encontrou marcadores claros\n  if (!subject && lines.length > 0) {\n    subject = lines[0].substring(0, 100); // Primeiros 100 chars\n  }\n  \n  if (!body) {\n    body = lines.slice(1).join('\\n');\n  }\n  \n  // Limpa formata√ß√£o markdown se houver\n  body = body.replace(/\\*\\*/g, '').replace(/\\*/g, '').trim();\n  subject = subject.replace(/\\*\\*/g, '').replace(/\\*/g, '').replace(/\"/g, '').trim();\n  \n  // Pega dados do lead\n  const leadData = $('‚öôÔ∏è Code - Parse Lead Score').first().json;\n  \n  output.push({\n    json: {\n      ...leadData,\n      emailSubject: subject,\n      emailBody: body\n    }\n  });\n}\n\nreturn output;"
      },
      "id": "5bd3797b-26e1-497b-a4ef-fe189321ce48",
      "name": "‚öôÔ∏è Code - Parse Email Claude",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1840,
        160
      ]
    },
    {
      "parameters": {
        "chatId": "YOUR_TELEGRAM_CHAT_ID",
        "text": "=üîî **NOVO LEAD AMJ - APROVA√á√ÉO NECESS√ÅRIA**\n\n**Lead #{{ $json.leadScore }}** - {{ $json.status }}\n\nüë§ **Nome:** {{ $json.nome }}\nüìß **Email:** {{ $json.email }}\nüì± **WhatsApp:** {{ $json.whatsapp }}\nüìç **Localiza√ß√£o:** {{ $json.cidade }}, {{ $json.distrito }}\nüéØ **Interesse:** {{ $json.interesse }}\n\n**üìä Score:** {{ $json.leadScore }}/100\n**üé≤ Convers√£o:** {{ $json.probabilidadeConversao }}\n\n**üìù AN√ÅLISE IA:**\n{{ $json.notasEnriquecimento }}\n\n---\n\n**‚úâÔ∏è EMAIL GERADO:**\n\n**Assunto:** {{ $json.emailSubject }}\n\n{{ $json.emailBody }}\n\n---\n\n**APROVAR ENVIO?**\n\n‚úÖ Digite: `/aprovar email {{ $json.email }}`\n‚ùå Digite: `/rejeitar email {{ $json.email }}`\n‚úèÔ∏è Editar: `/editar email {{ $json.email }}`",
        "additionalFields": {}
      },
      "id": "40d4fb21-f5ce-4dda-bcbb-39ae8f73158f",
      "name": "üì≤ Telegram - Pedir Aprova√ß√£o",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2032,
        160
      ],
      "webhookId": "4c1c2491-cd4f-408e-a63e-ebb3dc72c827",
      "disabled": true
    },
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "id": "fd847251-9c31-4820-a753-799d168d57d9",
      "name": "üì± Telegram - Receber Resposta",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [
        1840,
        368
      ],
      "webhookId": "telegram-approval-webhook",
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.message.text }}",
              "operation": "contains",
              "value2": "/aprovar email"
            }
          ]
        }
      },
      "id": "364e54ab-0113-4b14-a239-603c1f073283",
      "name": "‚ùì IF - Email Aprovado?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        2032,
        368
      ]
    },
    {
      "parameters": {
        "jsCode": "// Extrai email do comando Telegram\nconst items = $input.all();\nconst output = [];\n\nfor (const item of items) {\n  const command = item.json.message.text;\n  const emailMatch = command.match(/\\/aprovar email (.+)/);\n  \n  if (emailMatch) {\n    output.push({\n      json: {\n        approvedEmail: emailMatch[1].trim()\n      }\n    });\n  }\n}\n\nreturn output;"
      },
      "id": "9c8307b3-ffcf-40c5-836e-65e013cdb826",
      "name": "‚öôÔ∏è Code - Extrair Email Aprovado",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2240,
        272
      ]
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1YZ6oN42skTdjYT9uVAuLHXwAhlgxqe9gphygHtXuxzI",
          "mode": "list",
          "cachedResultName": "Leads AMJ",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1YZ6oN42skTdjYT9uVAuLHXwAhlgxqe9gphygHtXuxzI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "leads",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1YZ6oN42skTdjYT9uVAuLHXwAhlgxqe9gphygHtXuxzI/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "email",
              "lookupValue": "={{$json.approvedEmail}}"
            }
          ]
        },
        "options": {
          "returnAllMatches": "returnFirstMatch"
        }
      },
      "id": "c30b9272-eada-4142-969d-1ae9d89fd666",
      "name": "üîç Sheets - Buscar Lead Aprovado",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [
        2432,
        272
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mIkSlt9IkIuDsP58",
          "name": "Google Sheets - Leads"
        }
      }
    },
    {
      "parameters": {
        "fromEmail": "contato@alcinomenezesjunior.com",
        "toEmail": "={{ $json.email }}",
        "subject": "={{ $json.emailSubject }}",
        "options": {}
      },
      "id": "20f2ed61-bc0e-445a-bd3f-2de4eb100403",
      "name": "üìß Email - Enviar ao Lead",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        2640,
        272
      ],
      "webhookId": "974e6fd5-6a26-477d-aa19-9d08a6946ddc",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1YZ6oN42skTdjYT9uVAuLHXwAhlgxqe9gphygHtXuxzI",
          "mode": "list",
          "cachedResultName": "Leads AMJ",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1YZ6oN42skTdjYT9uVAuLHXwAhlgxqe9gphygHtXuxzI/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "leads",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1YZ6oN42skTdjYT9uVAuLHXwAhlgxqe9gphygHtXuxzI/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "email": "={{$json.email}}",
            "emailEnviado": "Sim - Email 1",
            "ultimaInteracao": "={{$now.toISO()}}",
            "meioContacto": "Email",
            "dataContacto": "={{$now.toFormat('dd/MM/yyyy HH:mm')}}"
          },
          "matchingColumns": [
            "email"
          ],
          "schema": [
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "nome",
              "displayName": "nome",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "instagram",
              "displayName": "instagram",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "whatsapp",
              "displayName": "whatsapp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "dataContacto",
              "displayName": "dataContacto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "meioContacto",
              "displayName": "meioContacto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "notasEnriquecimento",
              "displayName": "notasEnriquecimento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "leadScore",
              "displayName": "leadScore",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "emailEnviado",
              "displayName": "emailEnviado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "whatsappEnviado",
              "displayName": "whatsappEnviado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ultimaInteracao",
              "displayName": "ultimaInteracao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "interesse",
              "displayName": "interesse",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "servico",
              "displayName": "servico",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "origem",
              "displayName": "origem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "valorProposta",
              "displayName": "valorProposta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "probabilidadeConversao",
              "displayName": "probabilidadeConversao",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "observacoes",
              "displayName": "observacoes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "linkWhatsapp",
              "displayName": "linkWhatsapp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "dispositivo",
              "displayName": "dispositivo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "navegador",
              "displayName": "navegador",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "os",
              "displayName": "os",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pais",
              "displayName": "pais",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "distrito",
              "displayName": "distrito",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "cidade",
              "displayName": "cidade",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "provedor",
              "displayName": "provedor",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "referrer",
              "displayName": "referrer",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "idioma",
              "displayName": "idioma",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "origemCodigo",
              "displayName": "origemCodigo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "paginaOrigem",
              "displayName": "paginaOrigem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "7f5ed969-3092-4a41-a613-89a9128661dd",
      "name": "‚úÖ Sheets - Marcar Email Enviado",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [
        2832,
        272
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mIkSlt9IkIuDsP58",
          "name": "Google Sheets - Leads"
        }
      }
    },
    {
      "parameters": {
        "chatId": "YOUR_TELEGRAM_CHAT_ID",
        "text": "=‚úÖ **EMAIL ENVIADO COM SUCESSO**\n\nüë§ Lead: {{ $json.nome }}\nüìß Email: {{ $json.email }}\n‚è∞ Enviado: {{ $now.toFormat('dd/MM/yyyy HH:mm') }}\n\nüéØ Pr√≥ximos Passos:\n- Email 2: Autom√°tico em 24h\n- WhatsApp: Autom√°tico ap√≥s Email 2 (48h)\n\nüìä Status atualizado no Google Sheets",
        "additionalFields": {}
      },
      "id": "e64f1c8d-213e-49f3-8c7c-90f356e1859c",
      "name": "‚úÖ Telegram - Confirmar Envio",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3040,
        272
      ],
      "webhookId": "a401fab6-5e20-4ef2-a065-70cc4804d278",
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "YOUR_TELEGRAM_CHAT_ID",
        "text": "=‚ùå **EMAIL REJEITADO**\n\nüë§ Lead: {{ $json.nome }}\nüìß Email: {{ $json.email }}\n\nüí° Voc√™ pode:\n1. Enviar email manualmente\n2. Aguardar novo lead\n3. Editar e reenviar",
        "additionalFields": {}
      },
      "id": "2cd3d269-0d65-44dd-abad-df6cec598433",
      "name": "‚ùå Telegram - Email Rejeitado",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2240,
        464
      ],
      "webhookId": "1d130319-d00a-4821-928d-500dedf7fb66",
      "disabled": true
    },
    {
      "parameters": {
        "content": "## üéâ FASE 5: ATIVA√á√ÉO DE FOLLOW-UPS\n\n**Objetivo:** Iniciar sequ√™ncias autom√°ticas\n\n**Workflows Ativados:**\n1. ‚úâÔ∏è Email 2 (24h)\n2. üì± WhatsApp Twilio (48h)\n3. üîÑ Nurturing (leads mornos)\n\n**Crit√©rio:** Baseado no Lead Score\n\n**Status:** Sistema completo ativo",
        "height": 280,
        "width": 496,
        "color": 7
      },
      "id": "61aea5dc-69d1-43d6-8d7c-d65f8519dcd1",
      "name": "Sticky Note - Fase 5",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        3200,
        -128
      ]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.leadScore }}",
              "operation": "largerEqual",
              "value2": 50
            }
          ]
        }
      },
      "id": "37c10aeb-5708-4af6-845c-de42ce7c8712",
      "name": "üî• IF - Lead Quente/Morno?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        3232,
        272
      ]
    },
    {
      "parameters": {
        "workflowId": "={{ 'AMJ_Email_Sequence_2' }}",
        "options": {}
      },
      "id": "07eb80ad-436f-40f0-96c9-f7fe40b3416b",
      "name": "‚è∞ Execute - Email Sequence 2",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [
        3440,
        160
      ]
    },
    {
      "parameters": {
        "workflowId": "={{ 'AMJ_WhatsApp_Twilio_Followup' }}",
        "options": {}
      },
      "id": "e5801f51-cc30-4e55-8cc8-e4a495220a27",
      "name": "üì± Execute - WhatsApp Followup",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [
        3440,
        272
      ]
    },
    {
      "parameters": {
        "workflowId": "={{ 'AMJ_Lead_Nurturing' }}",
        "options": {}
      },
      "id": "b70faadd-1ffd-4377-9f18-76f6516ea4ab",
      "name": "üå± Execute - Lead Nurturing",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [
        3440,
        464
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  \"success\": true,\n  \"message\": \"Lead capturado e processado com sucesso!\",\n  \"leadEmail\": $json.email,\n  \"leadScore\": $json.leadScore,\n  \"status\": $json.status,\n  \"timestamp\": $now.toISO()\n} }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "219e481b-fc5c-43ab-88c3-1fed7b59be0d",
      "name": "‚úÖ Webhook Response - Sucesso",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        3632,
        272
      ]
    },
    {
      "parameters": {
        "content": "## üìã INSTRU√á√ïES DE CONFIGURA√á√ÉO\n\n**1. Google Sheets:**\n- Criar planilha \"Leads captados\"\n- Copiar ID do URL\n- Colar em todos nodes Google Sheets\n\n**2. Credenciais API:**\n- Perplexity API Key\n- OpenAI API Key\n- Anthropic API Key\n\n**3. Telegram Bot:**\n- Criar bot com @BotFather\n- Copiar token\n- Obter Chat ID\n\n**4. Testar:**\n- Enviar lead teste\n- Verificar Google Sheets\n- Aprovar no Telegram\n- Confirmar email recebido",
        "height": 572,
        "width": 510,
        "color": 2
      },
      "id": "18d570c7-6b01-4999-901b-0c2de9b908ca",
      "name": "Sticky Note - Instru√ß√µes",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -272,
        368
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "üéØ Webhook - Captura Lead": {
      "main": [
        [
          {
            "node": "üîÑ Merge - Dados Webhook",
            "type": "main",
            "index": 0
          },
          {
            "node": "üîÑ Merge - Dados Webhook",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "üîÑ Merge - Dados Webhook": {
      "main": [
        [
          {
            "node": "‚öôÔ∏è Code - Validar e Formatar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚öôÔ∏è Code - Validar e Formatar": {
      "main": [
        [
          {
            "node": "üîç Perplexity - Enriquecimento Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîç Perplexity - Enriquecimento Lead": {
      "main": [
        [
          {
            "node": "‚öôÔ∏è Code - Parse Perplexity",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚öôÔ∏è Code - Parse Perplexity": {
      "main": [
        [
          {
            "node": "üéØ GPT-4 - Lead Scoring",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üéØ GPT-4 - Lead Scoring": {
      "main": [
        [
          {
            "node": "‚öôÔ∏è Code - Parse Lead Score",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚öôÔ∏è Code - Parse Lead Score": {
      "main": [
        [
          {
            "node": "üìä Google Sheets - Salvar Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìä Google Sheets - Salvar Lead": {
      "main": [
        [
          {
            "node": "‚úâÔ∏è Claude - Gerar Email 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚úâÔ∏è Claude - Gerar Email 1": {
      "main": [
        [
          {
            "node": "‚öôÔ∏è Code - Parse Email Claude",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚öôÔ∏è Code - Parse Email Claude": {
      "main": [
        [
          {
            "node": "üì≤ Telegram - Pedir Aprova√ß√£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì± Telegram - Receber Resposta": {
      "main": [
        [
          {
            "node": "‚ùì IF - Email Aprovado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì IF - Email Aprovado?": {
      "main": [
        [
          {
            "node": "‚öôÔ∏è Code - Extrair Email Aprovado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "‚ùå Telegram - Email Rejeitado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚öôÔ∏è Code - Extrair Email Aprovado": {
      "main": [
        [
          {
            "node": "üîç Sheets - Buscar Lead Aprovado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîç Sheets - Buscar Lead Aprovado": {
      "main": [
        [
          {
            "node": "üìß Email - Enviar ao Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìß Email - Enviar ao Lead": {
      "main": [
        [
          {
            "node": "‚úÖ Sheets - Marcar Email Enviado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚úÖ Sheets - Marcar Email Enviado": {
      "main": [
        [
          {
            "node": "‚úÖ Telegram - Confirmar Envio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚úÖ Telegram - Confirmar Envio": {
      "main": [
        [
          {
            "node": "üî• IF - Lead Quente/Morno?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üî• IF - Lead Quente/Morno?": {
      "main": [
        [
          {
            "node": "‚è∞ Execute - Email Sequence 2",
            "type": "main",
            "index": 0
          },
          {
            "node": "üì± Execute - WhatsApp Followup",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üå± Execute - Lead Nurturing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚è∞ Execute - Email Sequence 2": {
      "main": [
        [
          {
            "node": "‚úÖ Webhook Response - Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì± Execute - WhatsApp Followup": {
      "main": [
        [
          {
            "node": "‚úÖ Webhook Response - Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üå± Execute - Lead Nurturing": {
      "main": [
        [
          {
            "node": "‚úÖ Webhook Response - Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "a2541ea7-2602-4950-b85e-1cbd14af615f",
  "meta": {
    "instanceId": "323c9b0d593df2deec4f9143de66619f0d3c68bbcf06bc32eb698efedd85ea5f"
  },
  "id": "UhpwEBmsBBUD1QV3",
  "tags": [
    {
      "updatedAt": "2025-11-18T20:36:33.297Z",
      "createdAt": "2025-11-18T20:36:33.297Z",
      "id": "8jzGLWnjkwh0RysZ",
      "name": "Lead Management"
    },
    {
      "updatedAt": "2025-11-18T20:36:33.307Z",
      "createdAt": "2025-11-18T20:36:33.307Z",
      "id": "lyvHCdwLjD0X89cB",
      "name": "AMJ Automation"
    }
  ]
}
