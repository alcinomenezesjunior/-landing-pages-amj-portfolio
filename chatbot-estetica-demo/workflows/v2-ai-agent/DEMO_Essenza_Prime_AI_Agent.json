{
  "name": "DEMO - Essenza Prime Clinic - AI Agent v2.0",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "testar-bot-whatsapp",
        "responseMode": "responseNode"
      },
      "id": "webhook-whatsapp-incoming",
      "name": "Webhook â€“ WhatsApp Incoming",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        240,
        300
      ],
      "webhookId": "essenza-prime-demo"
    },
    {
      "parameters": {
        "jsCode": "// Parse incoming WhatsApp message\nconst body = $input.item.json.body;\n\n// Extract message data\nconst phone = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.from || '';\nconst messageText = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.text?.body || '';\nconst messageId = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.id || '';\nconst timestamp = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.timestamp || '';\n\n// Check if this is a valid message\nif (!phone || !messageText) {\n  return {\n    json: {\n      skip: true,\n      reason: 'No valid message data'\n    }\n  };\n}\n\nreturn {\n  json: {\n    skip: false,\n    phone: phone,\n    message: messageText,\n    messageId: messageId,\n    timestamp: timestamp,\n    receivedAt: new Date().toISOString()\n  }\n};"
      },
      "id": "code-parse-message",
      "name": "Code â€“ Parse Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        460,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.skip}}",
              "value2": false
            }
          ]
        }
      },
      "id": "if-valid-message",
      "name": "IF â€“ Valid Message?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        680,
        300
      ]
    },
    {
      "parameters": {
        "operation": "select",
        "table": "clients",
        "returnAll": false,
        "limit": 10,
        "filterType": "string",
        "filterString": "phone=eq.{{$json.phone}}"
      },
      "id": "supabase-get-client",
      "name": "Supabase â€“ Get Client",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        900,
        200
      ],
      "credentials": {
        "supabaseApi": {
          "id": "1",
          "name": "Supabase - Essenza Prime"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.length > 0}}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-client-exists",
      "name": "IF â€“ Client Exists?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1120,
        200
      ]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "clients",
        "dataMode": "defineBelow",
        "valuesToSend": {
          "values": [
            {
              "column": "phone",
              "value": "={{$('Code â€“ Parse Message').item.json.phone}}"
            }
          ]
        }
      },
      "id": "supabase-create-client",
      "name": "Supabase â€“ Create Client",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1340,
        320
      ],
      "credentials": {
        "supabaseApi": {
          "id": "1",
          "name": "Supabase - Essenza Prime"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "table": "conversations",
        "returnAll": false,
        "limit": 1,
        "filterType": "string",
        "filterString": "phone=eq.{{$('Code â€“ Parse Message').item.json.phone}}"
      },
      "id": "supabase-get-conversation",
      "name": "Supabase â€“ Get Conversation",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1560,
        200
      ],
      "credentials": {
        "supabaseApi": {
          "id": "1",
          "name": "Supabase - Essenza Prime"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Merge client and conversation data\nconst parseData = $('Code â€“ Parse Message').first().json;\nconst clientData = $('IF â€“ Client Exists?').all()[0]?.json || $('Supabase â€“ Create Client').first().json;\nconst conversationData = $input.first().json;\n\nreturn {\n  json: {\n    phone: parseData.phone,\n    message: parseData.message,\n    messageId: parseData.messageId,\n    clientId: clientData.id,\n    clientName: clientData.name || null,\n    clientEmail: clientData.email || null,\n    conversationId: conversationData.id || null,\n    conversationState: conversationData.current_state || 'inicio',\n    conversationContext: conversationData.context || {},\n    conversationHistory: conversationData.messages || []\n  }\n};"
      },
      "id": "code-merge-data",
      "name": "Code â€“ Merge Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1780,
        200
      ]
    },
    {
      "parameters": {
        "model": "claude-sonnet-4-20250514",
        "maxTokens": 1500,
        "temperature": 0.7,
        "systemMessage": "Ã‰s a assistente virtual da Essenza Prime Clinic, uma clÃ­nica de estÃ©tica premium em Cascais, Lisboa.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nPERSONALIDADE E TOM\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n- Nome: NÃ£o tens nome especÃ­fico, Ã©s \"a assistente da Essenza Prime\"\n- Tom: Profissional mas acolhedor, elegante, nunca robÃ³tico\n- Linguagem: PortuguÃªs de Portugal (PT-PT), NUNCA brasileiro\n  - \"telemÃ³vel\" (nÃ£o \"celular\")\n  - \"autocarro\" (nÃ£o \"Ã´nibus\")\n  - \"marcaÃ§Ã£o\" (nÃ£o \"agendamento\")\n  - \"pequeno-almoÃ§o\" (nÃ£o \"cafÃ© da manhÃ£\")\n- Estilo: Frases claras e concisas, adequadas para WhatsApp\n- Emojis: Usa com moderaÃ§Ã£o (mÃ¡ximo 2 por mensagem)\n- Comprimento: Respostas curtas para perguntas simples, detalhadas quando necessÃ¡rio\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nO TEU PAPEL\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. Apresentar a clÃ­nica e os serviÃ§os quando o cliente chega\n2. Responder a perguntas sobre procedimentos, preÃ§os, duraÃ§Ãµes\n3. Informar sobre contraindicaÃ§Ãµes quando relevante\n4. Verificar disponibilidade de horÃ¡rios (usa tool check_availability)\n5. Fazer marcaÃ§Ãµes no calendÃ¡rio (usa tool create_booking)\n6. Gerar links de pagamento para depÃ³sitos (usa tool generate_payment_link)\n7. Processar cancelamentos e reagendamentos\n8. Processar reembolsos conforme polÃ­tica\n9. Sugerir upsells apÃ³s marcaÃ§Ã£o confirmada\n10. Oferecer downsells quando cliente quer cancelar por preÃ§o\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nMENSAGEM INICIAL\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nQuando o cliente envia a primeira mensagem (ex: \"OlÃ¡\", \"Quero testar\", etc.),\nresponde com uma apresentaÃ§Ã£o elegante:\n\n\"Bem-vinda Ã  Essenza Prime Clinic! âœ¨\n\nSou a assistente virtual e posso ajudar-te com:\nâ€¢ InformaÃ§Ãµes sobre tratamentos\nâ€¢ MarcaÃ§Ã£o de consultas\nâ€¢ VerificaÃ§Ã£o de disponibilidade\n\nA nossa clÃ­nica em Cascais oferece tratamentos faciais, corporais e micropigmentaÃ§Ã£o, com uma equipa de 8 especialistas.\n\nComo posso ajudar-te hoje?\"\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nDADOS DA CLÃNICA\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nNome: Essenza Prime Clinic, Unipessoal Lda.\nMorada: Cascais, Lisboa\nHorÃ¡rio: Segunda a Sexta 10:00-19:00, SÃ¡bado 10:00-14:00\nTelefone/WhatsApp: +351 926 699 009\nEmail: atendimento@essenzaprimeclinic.pt\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nEQUIPA (8 PROFISSIONAIS)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. Dr. Gustavo MendonÃ§a â€” MÃ©dico Esteta\n   ServiÃ§os: Peelings mÃ©dio/profundo, HarmonizaÃ§Ã£o, Preenchimentos\n   HorÃ¡rio: Seg-Sex 10:00-16:00\n\n2. Dra. Bruna Cortez â€” BiomÃ©dica Esteta\n   ServiÃ§os: Microagulhamento, Peelings, Limpeza, RadiofrequÃªncia\n   HorÃ¡rio: Ter/Qui/Sex 13:00-19:00, SÃ¡b 10:00-14:00\n\n3. Sra. SÃ­lvia Ramos â€” Esteticista Facial\n   ServiÃ§os: Limpeza de pele, Massagens, RadiofrequÃªncia facial\n   HorÃ¡rio: Seg/Qua/Sex 10:00-19:00, SÃ¡b 10:00-14:00\n\n4. Sra. Carla MagalhÃ£es â€” Esteticista Corporal\n   ServiÃ§os: Massagem modeladora, Drenagem, CriolipÃ³lise, RF corporal\n   HorÃ¡rio: Seg-Sex 13:00-19:00, SÃ¡b 10:00-14:00\n\n5. Sra. InÃªs Duarte â€” Especialista MicropigmentaÃ§Ã£o\n   ServiÃ§os: Microblading, MicropigmentaÃ§Ã£o lÃ¡bios/olhos\n   HorÃ¡rio: Seg/Qua/Qui 10:00-16:00, SÃ¡b 10:00-14:00\n\n6. Sra. Larissa GalvÃ£o â€” Esteticista Multidisciplinar\n   ServiÃ§os: Limpeza, Peelings superficiais, Microagulhamento, CriolipÃ³lise\n   HorÃ¡rio: Ter 10:00-19:00, Sex 10:00-13:00\n\n7. Sr. Pedro Moreira â€” Terapeuta Corporal\n   ServiÃ§os: Massagens, RF corporal, CriolipÃ³lise\n   HorÃ¡rio: Seg/Qua/Sex 16:00-19:00, SÃ¡b 10:00-14:00\n\n8. Sra. Renata Pinto â€” Assistente/Consultora\n   ServiÃ§os: AvaliaÃ§Ã£o inicial, OrientaÃ§Ã£o\n   HorÃ¡rio: Seg-Sex 10:00-19:00, SÃ¡b 10:00-14:00\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nCATÃLOGO DE SERVIÃ‡OS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nTRATAMENTOS FACIAIS:\nâ€¢ Limpeza de Pele Profunda â€” â‚¬40 (60-90 min)\nâ€¢ Peeling Superficial â€” â‚¬80 (30-45 min)\nâ€¢ Peeling MÃ©dio â€” â‚¬160 (45-60 min)\nâ€¢ RadiofrequÃªncia Facial â€” â‚¬100 (30-45 min)\nâ€¢ Microagulhamento â€” â‚¬120 (45-60 min)\nâ€¢ Ultrassom Microfocado (HIFU) â€” â‚¬200 (60-90 min)\nâ€¢ HarmonizaÃ§Ã£o Facial â€” â‚¬600 (60-90 min)\n\nTRATAMENTOS CORPORAIS:\nâ€¢ Massagem TerapÃªutica â€” â‚¬50 (50-60 min)\nâ€¢ Massagem Modeladora â€” â‚¬60 (50-60 min)\nâ€¢ Drenagem LinfÃ¡tica â€” â‚¬60 (50-60 min)\nâ€¢ RadiofrequÃªncia Corporal â€” â‚¬100 (45-60 min)\nâ€¢ CriolipÃ³lise â€” â‚¬120 (60-90 min)\nâ€¢ Massagem Detox â€” â‚¬55 (50-60 min)\n\nMICROPIGMENTAÃ‡ÃƒO:\nâ€¢ Microblading Sobrancelhas â€” â‚¬250 (90-120 min)\nâ€¢ MicropigmentaÃ§Ã£o LÃ¡bios â€” â‚¬280 (90-120 min)\nâ€¢ MicropigmentaÃ§Ã£o Eyeliner â€” â‚¬240 (60-90 min)\n\nCONSULTAS:\nâ€¢ AvaliaÃ§Ã£o Inicial â€” Gratuita (30 min)\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nPOLÃTICA DE DEPÃ“SITO E PAGAMENTO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nâ€¢ DepÃ³sito: 50% do valor total para confirmar marcaÃ§Ã£o\nâ€¢ DepÃ³sito mÃ­nimo: â‚¬20 (se procedimento < â‚¬40)\nâ€¢ Saldo: Pago no dia do procedimento\nâ€¢ Formas: MB WAY, TransferÃªncia, Multibanco, CartÃ£o (presencial)\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nPOLÃTICA DE CANCELAMENTO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nâ€¢ 7+ dias antes: 100% reembolso\nâ€¢ 3-7 dias antes: 75% reembolso (25% retenÃ§Ã£o)\nâ€¢ < 3 dias (atÃ© 24h): 50% reembolso\nâ€¢ < 24 horas: 25% reembolso\nâ€¢ NÃ£o comparecimento (no-show): 0% reembolso\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nFLUXO DE MARCAÃ‡ÃƒO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. Cliente indica interesse num serviÃ§o\n2. Explica o serviÃ§o (duraÃ§Ã£o, preÃ§o, o que inclui)\n3. Pergunta se quer marcar\n4. Verifica disponibilidade (tool: check_availability)\n5. Apresenta 3-5 opÃ§Ãµes de horÃ¡rio\n6. Cliente escolhe\n7. Pede: nome completo e email\n8. Confirma todos os dados\n9. Gera link de pagamento (tool: generate_payment_link)\n10. Aguarda confirmaÃ§Ã£o de pagamento\n11. Cria marcaÃ§Ã£o (tool: create_booking)\n12. Envia confirmaÃ§Ã£o final\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nUPSELL (ApÃ³s MarcaÃ§Ã£o Confirmada)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nQuando uma marcaÃ§Ã£o Ã© confirmada, sugere um serviÃ§o complementar:\n\nâ€¢ Limpeza de Pele â†’ Peeling Superficial (10% desconto)\nâ€¢ Peeling Superficial â†’ RadiofrequÃªncia Facial (10%)\nâ€¢ RadiofrequÃªncia â†’ Microagulhamento (10%)\nâ€¢ Massagem TerapÃªutica â†’ Drenagem LinfÃ¡tica (15%)\nâ€¢ Microblading â†’ MicropigmentaÃ§Ã£o LÃ¡bios (10%)\nâ€¢ CriolipÃ³lise â†’ RF Corporal (15%)\n\nExemplo de mensagem:\n\"A tua marcaÃ§Ã£o estÃ¡ confirmada! âœ…\n\nğŸ’¡ Muitas clientes combinam a Limpeza de Pele com um Peeling Superficial para resultados ainda melhores.\n\nğŸ Por marcares agora, tens 10% de desconto: â‚¬80 â†’ â‚¬72\n\nQueres adicionar? A Dra. Bruna tem disponibilidade logo apÃ³s.\"\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nDOWNSELL (No Cancelamento por PreÃ§o)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSe o cliente quer cancelar e menciona preÃ§o/dinheiro:\n\nâ€¢ Peeling MÃ©dio (â‚¬160) â†’ Peeling Superficial (â‚¬80)\nâ€¢ HarmonizaÃ§Ã£o (â‚¬600) â†’ RadiofrequÃªncia Facial (â‚¬100)\nâ€¢ Microagulhamento (â‚¬120) â†’ Limpeza de Pele (â‚¬40)\n\nExemplo:\n\"Entendo que o Peeling MÃ©dio Ã© um investimento maior.\n\nTenho uma alternativa: o Peeling Superficial (â‚¬80) tambÃ©m melhora manchas e textura, com menos tempo de recuperaÃ§Ã£o.\n\nO teu depÃ³sito de â‚¬80 cobre o valor total! Queres trocar em vez de cancelar?\"\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nLIVRO DE RECLAMAÃ‡Ã•ES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSe perguntarem sobre reclamaÃ§Ãµes:\n\n\"A Essenza Prime Clinic disponibiliza o Livro de ReclamaÃ§Ãµes EletrÃ³nico conforme a legislaÃ§Ã£o portuguesa.\n\nPodes aceder em: www.livroreclamacoes.pt\n\nSe preferires resolver directamente, posso pedir a um responsÃ¡vel para te contactar. O que preferes?\"\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nREGRAS IMPORTANTES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. NUNCA inventes informaÃ§Ã£o â€” usa apenas o que estÃ¡ acima\n2. NUNCA digas que Ã©s demo ou teste â€” age como assistente real\n3. SEMPRE verifica disponibilidade antes de confirmar marcaÃ§Ã£o\n4. SEMPRE confirma dados antes de criar evento\n5. SEMPRE informa sobre depÃ³sito de 50%\n6. SEMPRE usa PT-PT, nunca portuguÃªs do Brasil\n7. Se nÃ£o souberes algo, oferece contacto humano:\n   \"Posso pedir a um colega para te contactar para esclarecer isso.\"\n8. SÃª empÃ¡tica com cancelamentos â€” nÃ£o julgues\n9. Quando o cliente mencionar dificuldade financeira, oferece alternativas\n10. MantÃ©m histÃ³rico da conversa â€” nÃ£o perguntes o que jÃ¡ foi dito",
        "chatHistory": "={{$json.conversationHistory}}",
        "prompt": "={{$json.message}}",
        "tools": [
          {
            "name": "check_availability",
            "description": "Verifica horÃ¡rios disponÃ­veis no Google Calendar para um serviÃ§o/profissional",
            "parameters": {
              "type": "object",
              "properties": {
                "service_name": {
                  "type": "string",
                  "description": "Nome do serviÃ§o (ex: 'Limpeza de Pele Profunda')"
                },
                "professional_name": {
                  "type": "string",
                  "description": "Nome do profissional preferido (opcional)"
                },
                "date_from": {
                  "type": "string",
                  "description": "Data inicial no formato YYYY-MM-DD"
                },
                "date_to": {
                  "type": "string",
                  "description": "Data final no formato YYYY-MM-DD"
                }
              },
              "required": [
                "service_name",
                "date_from",
                "date_to"
              ]
            }
          },
          {
            "name": "create_booking",
            "description": "Cria uma marcaÃ§Ã£o no Google Calendar e regista no Supabase",
            "parameters": {
              "type": "object",
              "properties": {
                "service_name": {
                  "type": "string"
                },
                "professional_name": {
                  "type": "string"
                },
                "date": {
                  "type": "string",
                  "description": "YYYY-MM-DD"
                },
                "time_start": {
                  "type": "string",
                  "description": "HH:MM"
                },
                "duration_minutes": {
                  "type": "integer"
                },
                "client_name": {
                  "type": "string"
                },
                "client_phone": {
                  "type": "string"
                },
                "client_email": {
                  "type": "string"
                },
                "price": {
                  "type": "number"
                },
                "deposit": {
                  "type": "number"
                },
                "stripe_payment_id": {
                  "type": "string"
                }
              },
              "required": [
                "service_name",
                "professional_name",
                "date",
                "time_start",
                "duration_minutes",
                "client_name",
                "client_phone",
                "price"
              ]
            }
          },
          {
            "name": "generate_payment_link",
            "description": "Gera um link Stripe Checkout para pagamento do depÃ³sito",
            "parameters": {
              "type": "object",
              "properties": {
                "amount_cents": {
                  "type": "integer",
                  "description": "Valor em cÃªntimos"
                },
                "service_name": {
                  "type": "string"
                },
                "client_email": {
                  "type": "string"
                },
                "client_phone": {
                  "type": "string"
                },
                "booking_date": {
                  "type": "string"
                },
                "booking_time": {
                  "type": "string"
                }
              },
              "required": [
                "amount_cents",
                "service_name",
                "client_phone"
              ]
            }
          },
          {
            "name": "cancel_booking",
            "description": "Cancela uma marcaÃ§Ã£o e processa reembolso conforme polÃ­tica",
            "parameters": {
              "type": "object",
              "properties": {
                "client_phone": {
                  "type": "string"
                },
                "booking_date": {
                  "type": "string",
                  "description": "YYYY-MM-DD"
                },
                "reason": {
                  "type": "string",
                  "description": "Motivo do cancelamento"
                }
              },
              "required": [
                "client_phone",
                "booking_date"
              ]
            }
          },
          {
            "name": "reschedule_booking",
            "description": "Reagenda uma marcaÃ§Ã£o para nova data/hora",
            "parameters": {
              "type": "object",
              "properties": {
                "client_phone": {
                  "type": "string"
                },
                "old_date": {
                  "type": "string"
                },
                "new_date": {
                  "type": "string"
                },
                "new_time": {
                  "type": "string"
                }
              },
              "required": [
                "client_phone",
                "old_date",
                "new_date",
                "new_time"
              ]
            }
          },
          {
            "name": "process_refund",
            "description": "Processa reembolso via Stripe",
            "parameters": {
              "type": "object",
              "properties": {
                "stripe_payment_id": {
                  "type": "string"
                },
                "refund_percentage": {
                  "type": "integer",
                  "description": "0-100"
                },
                "reason": {
                  "type": "string"
                }
              },
              "required": [
                "stripe_payment_id",
                "refund_percentage"
              ]
            }
          },
          {
            "name": "get_care_instructions",
            "description": "ObtÃ©m cuidados prÃ© ou pÃ³s procedimento",
            "parameters": {
              "type": "object",
              "properties": {
                "service_name": {
                  "type": "string"
                },
                "instruction_type": {
                  "type": "string",
                  "enum": [
                    "pre",
                    "post"
                  ]
                }
              },
              "required": [
                "service_name",
                "instruction_type"
              ]
            }
          },
          {
            "name": "get_professional_info",
            "description": "ObtÃ©m informaÃ§Ã£o sobre um profissional",
            "parameters": {
              "type": "object",
              "properties": {
                "professional_name": {
                  "type": "string"
                },
                "info_type": {
                  "type": "string",
                  "enum": [
                    "services",
                    "schedule",
                    "bio"
                  ]
                }
              },
              "required": [
                "professional_name"
              ]
            }
          }
        ],
        "options": {}
      },
      "id": "ai-agent-claude",
      "name": "AI Agent â€“ Claude Sonnet 4",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        2000,
        200
      ],
      "credentials": {
        "anthropicApi": {
          "id": "1",
          "name": "Anthropic API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Check if AI Agent made any tool calls\nconst aiResponse = $input.first().json;\nconst toolCalls = aiResponse.toolCalls || [];\nconst mergedData = $('Code â€“ Merge Data').first().json;\n\nif (toolCalls.length > 0) {\n  return {\n    json: {\n      hasToolCalls: true,\n      toolCalls: toolCalls,\n      originalResponse: aiResponse.output,\n      phone: mergedData.phone,\n      clientId: mergedData.clientId,\n      clientName: mergedData.clientName,\n      clientEmail: mergedData.clientEmail,\n      conversationId: mergedData.conversationId,\n      conversationState: mergedData.conversationState,\n      conversationHistory: mergedData.conversationHistory\n    }\n  };\n} else {\n  return {\n    json: {\n      hasToolCalls: false,\n      responseText: aiResponse.output,\n      phone: mergedData.phone,\n      clientId: mergedData.clientId,\n      conversationId: mergedData.conversationId,\n      conversationState: mergedData.conversationState,\n      conversationHistory: mergedData.conversationHistory\n    }\n  };\n}"
      },
      "id": "code-check-tool-calls",
      "name": "Code â€“ Check Tool Calls",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2220,
        200
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.hasToolCalls}}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-has-tool-calls",
      "name": "IF â€“ Has Tool Calls?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        2440,
        200
      ]
    },
    {
      "parameters": {
        "dataType": "string",
        "value1": "={{$json.toolCalls[0].name}}",
        "rules": {
          "string": [
            {
              "value2": "check_availability"
            },
            {
              "value2": "create_booking"
            },
            {
              "value2": "generate_payment_link"
            },
            {
              "value2": "cancel_booking"
            },
            {
              "value2": "reschedule_booking"
            },
            {
              "value2": "process_refund"
            },
            {
              "value2": "get_care_instructions"
            },
            {
              "value2": "get_professional_info"
            }
          ]
        },
        "fallbackOutput": "extra"
      },
      "id": "switch-route-by-tool",
      "name": "Switch â€“ Route by Tool",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 2,
      "position": [
        2660,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "// TOOL 1: check_availability - Parse arguments\nconst toolCall = $input.first().json.toolCalls[0];\nconst args = toolCall.arguments;\n\nreturn {\n  json: {\n    toolName: 'check_availability',\n    serviceName: args.service_name,\n    professionalName: args.professional_name || null,\n    dateFrom: args.date_from,\n    dateTo: args.date_to,\n    phone: $input.first().json.phone,\n    clientId: $input.first().json.clientId\n  }\n};"
      },
      "id": "tool1-parse-args",
      "name": "Tool 1 â€“ Parse Arguments",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2880,
        -100
      ]
    },
    {
      "parameters": {
        "operation": "select",
        "table": "services",
        "returnAll": false,
        "limit": 1,
        "filterType": "string",
        "filterString": "name=eq.{{$json.serviceName}}"
      },
      "id": "tool1-get-service",
      "name": "Tool 1 â€“ Get Service",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        3100,
        -100
      ],
      "credentials": {
        "supabaseApi": {
          "id": "1",
          "name": "Supabase - Essenza Prime"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "table": "professionals",
        "returnAll": true,
        "filterType": "string",
        "filterString": "services=cs.{{{$('Tool 1 â€“ Parse Arguments').item.json.serviceName}}}"
      },
      "id": "tool1-get-professionals",
      "name": "Tool 1 â€“ Get Professionals",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        3320,
        -100
      ],
      "credentials": {
        "supabaseApi": {
          "id": "1",
          "name": "Supabase - Essenza Prime"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "d682359e9a244ab7f9a7f7e925d05bf9a6def533796af78a1ecba749103b59c8@group.calendar.google.com",
          "mode": "id"
        },
        "returnAll": false,
        "limit": 100,
        "timeMin": "={{$('Tool 1 â€“ Parse Arguments').item.json.dateFrom}}T00:00:00Z",
        "timeMax": "={{$('Tool 1 â€“ Parse Arguments').item.json.dateTo}}T23:59:59Z"
      },
      "id": "tool1-get-calendar-events",
      "name": "Tool 1 â€“ Get Calendar Events",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.2,
      "position": [
        3540,
        -100
      ],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "3",
          "name": "Google Calendar OAuth2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Calculate available slots\nconst parseData = $('Tool 1 â€“ Parse Arguments').first().json;\nconst serviceData = $('Tool 1 â€“ Get Service').first().json;\nconst professionals = $('Tool 1 â€“ Get Professionals').all();\nconst calendarEvents = $('Tool 1 â€“ Get Calendar Events').all();\n\nconst serviceName = parseData.serviceName;\nconst professionalFilter = parseData.professionalName;\nconst dateFrom = new Date(parseData.dateFrom);\nconst dateTo = new Date(parseData.dateTo);\nconst durationMinutes = serviceData.duration_max || 60;\n\n// Helper: Parse time string to minutes since midnight\nfunction timeToMinutes(timeStr) {\n  const [hours, minutes] = timeStr.split(':').map(Number);\n  return hours * 60 + minutes;\n}\n\n// Helper: Format minutes to time string\nfunction minutesToTime(minutes) {\n  const hours = Math.floor(minutes / 60).toString().padStart(2, '0');\n  const mins = (minutes % 60).toString().padStart(2, '0');\n  return `${hours}:${mins}`;\n}\n\n// Helper: Format date to YYYY-MM-DD\nfunction formatDate(date) {\n  return date.toISOString().split('T')[0];\n}\n\n// Build busy times from calendar events\nconst busyTimes = calendarEvents.map(event => ({\n  start: new Date(event.json.start.dateTime || event.json.start.date),\n  end: new Date(event.json.end.dateTime || event.json.end.date)\n}));\n\nconst availableSlots = [];\n\n// Process each professional\nfor (const prof of professionals) {\n  const profName = prof.json.name;\n  \n  // Filter by professional if specified\n  if (professionalFilter && !profName.toLowerCase().includes(professionalFilter.toLowerCase())) {\n    continue;\n  }\n  \n  const schedule = prof.json.schedule || {};\n  \n  // Iterate through date range\n  let currentDate = new Date(dateFrom);\n  while (currentDate <= dateTo) {\n    const dayName = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][currentDate.getDay()];\n    const daySchedule = schedule[dayName];\n    \n    if (daySchedule && daySchedule.start && daySchedule.end) {\n      const workStart = timeToMinutes(daySchedule.start);\n      const workEnd = timeToMinutes(daySchedule.end);\n      \n      // Generate slots every 30 minutes\n      let slotStart = workStart;\n      while (slotStart + durationMinutes <= workEnd) {\n        const slotEnd = slotStart + durationMinutes;\n        \n        // Create date objects for this slot\n        const slotStartDate = new Date(currentDate);\n        slotStartDate.setHours(Math.floor(slotStart / 60), slotStart % 60, 0, 0);\n        \n        const slotEndDate = new Date(currentDate);\n        slotEndDate.setHours(Math.floor(slotEnd / 60), slotEnd % 60, 0, 0);\n        \n        // Check if slot conflicts with any busy time (with 15min buffer)\n        const hasConflict = busyTimes.some(busy => {\n          const bufferMs = 15 * 60 * 1000; // 15 minutes buffer\n          return (\n            (slotStartDate >= new Date(busy.start.getTime() - bufferMs) && slotStartDate < busy.end) ||\n            (slotEndDate > busy.start && slotEndDate <= new Date(busy.end.getTime() + bufferMs)) ||\n            (slotStartDate <= busy.start && slotEndDate >= busy.end)\n          );\n        });\n        \n        if (!hasConflict) {\n          availableSlots.push({\n            date: formatDate(currentDate),\n            time: minutesToTime(slotStart),\n            professional: profName\n          });\n        }\n        \n        slotStart += 30; // 30 minute intervals\n      }\n    }\n    \n    currentDate.setDate(currentDate.getDate() + 1);\n  }\n}\n\n// Return top 5 slots\nconst topSlots = availableSlots.slice(0, 5);\n\nreturn {\n  json: {\n    toolName: 'check_availability',\n    success: true,\n    available_slots: topSlots,\n    total_found: availableSlots.length\n  }\n};"
      },
      "id": "tool1-calculate-slots",
      "name": "Tool 1 â€“ Calculate Available Slots",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3760,
        -100
      ]
    },
    {
      "parameters": {
        "jsCode": "// TOOL 2: create_booking - Parse arguments\nconst toolCall = $input.first().json.toolCalls[0];\nconst args = toolCall.arguments;\n\nreturn {\n  json: {\n    toolName: 'create_booking',\n    serviceName: args.service_name,\n    professionalName: args.professional_name,\n    date: args.date,\n    timeStart: args.time_start,\n    durationMinutes: args.duration_minutes,\n    clientName: args.client_name,\n    clientPhone: args.client_phone,\n    clientEmail: args.client_email || '',\n    price: args.price,\n    deposit: args.deposit || (args.price * 0.5),\n    stripePaymentId: args.stripe_payment_id || '',\n    phone: $input.first().json.phone,\n    clientId: $input.first().json.clientId\n  }\n};"
      },
      "id": "tool2-parse-args",
      "name": "Tool 2 â€“ Parse Arguments",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2880,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "// Prepare Google Calendar event data\nconst data = $input.first().json;\n\nconst eventSummary = `[MARCAÃ‡ÃƒO] ${data.serviceName} - ${data.clientName}`;\nconst eventDescription = `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nDADOS DO CLIENTE\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nNome: ${data.clientName}\nWhatsApp: ${data.clientPhone}\nEmail: ${data.clientEmail}\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nDETALHES DA MARCAÃ‡ÃƒO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nServiÃ§o: ${data.serviceName}\nProfissional: ${data.professionalName}\nDuraÃ§Ã£o: ${data.durationMinutes} min\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nPAGAMENTO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nPreÃ§o Total: â‚¬${data.price}\nDepÃ³sito (50%): â‚¬${data.deposit}\nEstado: ${data.stripePaymentId ? 'Pago' : 'Pendente'}\nStripe ID: ${data.stripePaymentId}\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nSISTEMA\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nCriado via: Chatbot WhatsApp\nTimestamp: ${new Date().toISOString()}`;\n\n// Calculate end time\nconst [hours, minutes] = data.timeStart.split(':').map(Number);\nconst startDate = new Date(`${data.date}T${data.timeStart}:00`);\nconst endDate = new Date(startDate.getTime() + data.durationMinutes * 60000);\n\nreturn {\n  json: {\n    summary: eventSummary,\n    description: eventDescription,\n    start: startDate.toISOString(),\n    end: endDate.toISOString(),\n    ...data\n  }\n};"
      },
      "id": "tool2-prepare-calendar-data",
      "name": "Tool 2 â€“ Prepare Calendar Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3100,
        0
      ]
    },
    {
      "parameters": {
        "operation": "create",
        "calendar": {
          "__rl": true,
          "value": "d682359e9a244ab7f9a7f7e925d05bf9a6def533796af78a1ecba749103b59c8@group.calendar.google.com",
          "mode": "id"
        },
        "summary": "={{$json.summary}}",
        "description": "={{$json.description}}",
        "start": "={{$json.start}}",
        "end": "={{$json.end}}"
      },
      "id": "tool2-create-calendar-event",
      "name": "Tool 2 â€“ Create Calendar Event",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.2,
      "position": [
        3320,
        0
      ],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "3",
          "name": "Google Calendar OAuth2"
        }
      }
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "appointments",
        "dataMode": "defineBelow",
        "valuesToSend": {
          "values": [
            {
              "column": "client_id",
              "value": "={{$('Tool 2 â€“ Parse Arguments').item.json.clientId}}"
            },
            {
              "column": "service",
              "value": "={{$('Tool 2 â€“ Parse Arguments').item.json.serviceName}}"
            },
            {
              "column": "professional",
              "value": "={{$('Tool 2 â€“ Parse Arguments').item.json.professionalName}}"
            },
            {
              "column": "date",
              "value": "={{$('Tool 2 â€“ Parse Arguments').item.json.date}}"
            },
            {
              "column": "time_start",
              "value": "={{$('Tool 2 â€“ Parse Arguments').item.json.timeStart}}"
            },
            {
              "column": "duration_minutes",
              "value": "={{$('Tool 2 â€“ Parse Arguments').item.json.durationMinutes}}"
            },
            {
              "column": "price",
              "value": "={{$('Tool 2 â€“ Parse Arguments').item.json.price}}"
            },
            {
              "column": "deposit",
              "value": "={{$('Tool 2 â€“ Parse Arguments').item.json.deposit}}"
            },
            {
              "column": "deposit_paid",
              "value": "={{$('Tool 2 â€“ Parse Arguments').item.json.stripePaymentId ? true : false}}"
            },
            {
              "column": "stripe_payment_id",
              "value": "={{$('Tool 2 â€“ Parse Arguments').item.json.stripePaymentId}}"
            },
            {
              "column": "google_calendar_event_id",
              "value": "={{$json.id}}"
            },
            {
              "column": "status",
              "value": "confirmed"
            }
          ]
        }
      },
      "id": "tool2-create-appointment",
      "name": "Tool 2 â€“ Create Appointment",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        3540,
        0
      ],
      "credentials": {
        "supabaseApi": {
          "id": "1",
          "name": "Supabase - Essenza Prime"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Schedule automated messages\nconst parseData = $('Tool 2 â€“ Parse Arguments').first().json;\nconst appointmentData = $input.first().json;\n\nconst appointmentId = appointmentData.id;\nconst appointmentDateTime = new Date(`${parseData.date}T${parseData.timeStart}:00`);\n\n// Calculate scheduled times\nconst messages = [\n  {\n    type: 'reminder_24h',\n    scheduledFor: new Date(appointmentDateTime.getTime() - 24 * 60 * 60 * 1000).toISOString()\n  },\n  {\n    type: 'reminder_1h',\n    scheduledFor: new Date(appointmentDateTime.getTime() - 60 * 60 * 1000).toISOString()\n  },\n  {\n    type: 'post_care',\n    scheduledFor: new Date(appointmentDateTime.getTime() + (parseData.durationMinutes + 15) * 60 * 1000).toISOString()\n  },\n  {\n    type: 'follow_up_2h',\n    scheduledFor: new Date(appointmentDateTime.getTime() + (parseData.durationMinutes + 120) * 60 * 1000).toISOString()\n  },\n  {\n    type: 'follow_up_7d',\n    scheduledFor: new Date(appointmentDateTime.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString()\n  }\n];\n\nreturn messages.map(msg => ({\n  json: {\n    appointment_id: appointmentId,\n    client_phone: parseData.clientPhone,\n    message_type: msg.type,\n    scheduled_for: msg.scheduledFor,\n    sent: false\n  }\n}));"
      },
      "id": "tool2-prepare-scheduled-messages",
      "name": "Tool 2 â€“ Prepare Scheduled Messages",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3760,
        0
      ]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "scheduled_messages",
        "dataMode": "defineBelow",
        "valuesToSend": {
          "values": [
            {
              "column": "appointment_id",
              "value": "={{$json.appointment_id}}"
            },
            {
              "column": "client_phone",
              "value": "={{$json.client_phone}}"
            },
            {
              "column": "message_type",
              "value": "={{$json.message_type}}"
            },
            {
              "column": "scheduled_for",
              "value": "={{$json.scheduled_for}}"
            },
            {
              "column": "sent",
              "value": "={{$json.sent}}"
            }
          ]
        }
      },
      "id": "tool2-create-scheduled-messages",
      "name": "Tool 2 â€“ Create Scheduled Messages",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        3980,
        0
      ],
      "credentials": {
        "supabaseApi": {
          "id": "1",
          "name": "Supabase - Essenza Prime"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Format tool result for AI Agent\nconst appointmentData = $('Tool 2 â€“ Create Appointment').first().json;\nconst parseData = $('Tool 2 â€“ Parse Arguments').first().json;\n\nreturn {\n  json: {\n    toolName: 'create_booking',\n    success: true,\n    appointment_id: appointmentData.id,\n    calendar_event_id: appointmentData.google_calendar_event_id,\n    message: `MarcaÃ§Ã£o criada com sucesso para ${parseData.clientName} - ${parseData.serviceName} em ${parseData.date} Ã s ${parseData.timeStart}`\n  }\n};"
      },
      "id": "tool2-format-result",
      "name": "Tool 2 â€“ Format Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4200,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "// TOOL 3: generate_payment_link - Parse arguments\nconst toolCall = $input.first().json.toolCalls[0];\nconst args = toolCall.arguments;\n\nreturn {\n  json: {\n    toolName: 'generate_payment_link',\n    amountCents: args.amount_cents,\n    serviceName: args.service_name,\n    clientEmail: args.client_email || '',\n    clientPhone: args.client_phone,\n    bookingDate: args.booking_date || '',\n    bookingTime: args.booking_time || '',\n    phone: $input.first().json.phone\n  }\n};"
      },
      "id": "tool3-parse-args",
      "name": "Tool 3 â€“ Parse Arguments",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2880,
        100
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.stripe.com/v1/checkout/sessions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/x-www-form-urlencoded"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "string",
        "bodyContentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "mode",
              "value": "payment"
            },
            {
              "name": "success_url",
              "value": "https://www.alcinomenezesjunior.com/chatbot-estetica?pagamento=sucesso"
            },
            {
              "name": "cancel_url",
              "value": "https://www.alcinomenezesjunior.com/chatbot-estetica?pagamento=cancelado"
            },
            {
              "name": "line_items[0][price_data][currency]",
              "value": "eur"
            },
            {
              "name": "line_items[0][price_data][product_data][name]",
              "value": "=DepÃ³sito - {{$json.serviceName}}"
            },
            {
              "name": "line_items[0][price_data][unit_amount]",
              "value": "={{$json.amountCents}}"
            },
            {
              "name": "line_items[0][quantity]",
              "value": "1"
            },
            {
              "name": "metadata[phone]",
              "value": "={{$json.clientPhone}}"
            },
            {
              "name": "metadata[service]",
              "value": "={{$json.serviceName}}"
            },
            {
              "name": "metadata[date]",
              "value": "={{$json.bookingDate}}"
            },
            {
              "name": "metadata[time]",
              "value": "={{$json.bookingTime}}"
            },
            {
              "name": "customer_email",
              "value": "={{$json.clientEmail}}"
            }
          ]
        }
      },
      "id": "tool3-create-stripe-session",
      "name": "Tool 3 â€“ Create Stripe Session",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3100,
        100
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "4",
          "name": "Stripe Secret Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Format tool result for AI Agent\nconst stripeResponse = $input.first().json;\n\nreturn {\n  json: {\n    toolName: 'generate_payment_link',\n    success: true,\n    payment_url: stripeResponse.url,\n    session_id: stripeResponse.id\n  }\n};"
      },
      "id": "tool3-format-result",
      "name": "Tool 3 â€“ Format Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3320,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "// Placeholder for tools 4-8\nconst toolCall = $input.first().json.toolCalls[0];\n\nreturn {\n  json: {\n    toolName: toolCall.name,\n    success: false,\n    message: `Tool ${toolCall.name} nÃ£o implementada ainda. Implementar conforme TOOLS_IMPLEMENTATION.md`\n  }\n};"
      },
      "id": "tools-placeholder",
      "name": "Tools 4-8 â€“ Placeholder",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2880,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// Merge tool results back to AI Agent format\nconst toolResult = $input.first().json;\nconst originalData = $('Code â€“ Check Tool Calls').first().json;\n\n// Format result as tool response for AI Agent\nconst toolResponse = {\n  toolCallId: originalData.toolCalls[0].id || 'tool-call-1',\n  toolName: toolResult.toolName,\n  result: JSON.stringify(toolResult)\n};\n\nreturn {\n  json: {\n    phone: originalData.phone,\n    clientId: originalData.clientId,\n    conversationId: originalData.conversationId,\n    conversationState: originalData.conversationState,\n    conversationHistory: originalData.conversationHistory,\n    toolResult: toolResponse,\n    responseText: `[Tool executed: ${toolResult.toolName}] ${toolResult.message || JSON.stringify(toolResult)}`,\n    hasMoreToolCalls: originalData.toolCalls.length > 1\n  }\n};"
      },
      "id": "code-merge-tool-results",
      "name": "Code â€“ Merge Tool Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3980,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// Process AI response and prepare for database update\nconst responseData = $input.first().json;\nconst mergedData = $('Code â€“ Merge Data').first().json;\n\n// Add new message to history\nconst messages = mergedData.conversationHistory || [];\n\nif (!responseData.toolResult) {\n  // Regular response (no tool calls)\n  messages.push({\n    role: 'user',\n    content: mergedData.message,\n    timestamp: new Date().toISOString()\n  });\n  messages.push({\n    role: 'assistant',\n    content: responseData.responseText,\n    timestamp: new Date().toISOString()\n  });\n}\n\n// Keep only last 20 messages for context\nconst trimmedMessages = messages.slice(-20);\n\n// Extract any booking intent from context\nconst hasBookingIntent = responseData.responseText.toLowerCase().includes('marcar') || \n                         responseData.responseText.toLowerCase().includes('disponibilidade');\n\nreturn {\n  json: {\n    phone: responseData.phone,\n    clientId: responseData.clientId,\n    conversationId: responseData.conversationId,\n    messages: trimmedMessages,\n    currentState: hasBookingIntent ? 'choosing_service' : responseData.conversationState,\n    responseText: responseData.responseText\n  }\n};"
      },
      "id": "code-process-response",
      "name": "Code â€“ Process Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2660,
        300
      ]
    },
    {
      "parameters": {
        "operation": "upsert",
        "table": "conversations",
        "dataMode": "defineBelow",
        "valuesToSend": {
          "values": [
            {
              "column": "client_id",
              "value": "={{$json.clientId}}"
            },
            {
              "column": "phone",
              "value": "={{$json.phone}}"
            },
            {
              "column": "messages",
              "value": "={{JSON.stringify($json.messages)}}"
            },
            {
              "column": "current_state",
              "value": "={{$json.currentState}}"
            }
          ]
        }
      },
      "id": "supabase-update-conversation",
      "name": "Supabase â€“ Update Conversation",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2880,
        300
      ],
      "credentials": {
        "supabaseApi": {
          "id": "1",
          "name": "Supabase - Essenza Prime"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v18.0/{{$env.WHATSAPP_PHONE_NUMBER_ID}}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{$('Code â€“ Process Response').item.json.phone}}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"{{$('Code â€“ Process Response').item.json.responseText}}\"\n  }\n}"
      },
      "id": "whatsapp-send-message",
      "name": "WhatsApp â€“ Send Message",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3100,
        300
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "2",
          "name": "WhatsApp Cloud API Token"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"status\": \"success\", \"message\": \"Message processed\"}"
      },
      "id": "webhook-response",
      "name": "Webhook Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        3320,
        300
      ]
    }
  ],
  "connections": {
    "Webhook â€“ WhatsApp Incoming": {
      "main": [
        [
          {
            "node": "Code â€“ Parse Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code â€“ Parse Message": {
      "main": [
        [
          {
            "node": "IF â€“ Valid Message?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF â€“ Valid Message?": {
      "main": [
        [
          {
            "node": "Supabase â€“ Get Client",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase â€“ Get Client": {
      "main": [
        [
          {
            "node": "IF â€“ Client Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF â€“ Client Exists?": {
      "main": [
        [
          {
            "node": "Supabase â€“ Get Conversation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Supabase â€“ Create Client",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase â€“ Create Client": {
      "main": [
        [
          {
            "node": "Supabase â€“ Get Conversation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase â€“ Get Conversation": {
      "main": [
        [
          {
            "node": "Code â€“ Merge Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code â€“ Merge Data": {
      "main": [
        [
          {
            "node": "AI Agent â€“ Claude Sonnet 4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent â€“ Claude Sonnet 4": {
      "main": [
        [
          {
            "node": "Code â€“ Check Tool Calls",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code â€“ Check Tool Calls": {
      "main": [
        [
          {
            "node": "IF â€“ Has Tool Calls?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF â€“ Has Tool Calls?": {
      "main": [
        [
          {
            "node": "Switch â€“ Route by Tool",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code â€“ Process Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch â€“ Route by Tool": {
      "main": [
        [
          {
            "node": "Tool 1 â€“ Parse Arguments",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Tool 2 â€“ Parse Arguments",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Tool 3 â€“ Parse Arguments",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Tools 4-8 â€“ Placeholder",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Tools 4-8 â€“ Placeholder",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Tools 4-8 â€“ Placeholder",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Tools 4-8 â€“ Placeholder",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Tools 4-8 â€“ Placeholder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tool 1 â€“ Parse Arguments": {
      "main": [
        [
          {
            "node": "Tool 1 â€“ Get Service",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tool 1 â€“ Get Service": {
      "main": [
        [
          {
            "node": "Tool 1 â€“ Get Professionals",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tool 1 â€“ Get Professionals": {
      "main": [
        [
          {
            "node": "Tool 1 â€“ Get Calendar Events",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tool 1 â€“ Get Calendar Events": {
      "main": [
        [
          {
            "node": "Tool 1 â€“ Calculate Available Slots",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tool 1 â€“ Calculate Available Slots": {
      "main": [
        [
          {
            "node": "Code â€“ Merge Tool Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tool 2 â€“ Parse Arguments": {
      "main": [
        [
          {
            "node": "Tool 2 â€“ Prepare Calendar Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tool 2 â€“ Prepare Calendar Data": {
      "main": [
        [
          {
            "node": "Tool 2 â€“ Create Calendar Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tool 2 â€“ Create Calendar Event": {
      "main": [
        [
          {
            "node": "Tool 2 â€“ Create Appointment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tool 2 â€“ Create Appointment": {
      "main": [
        [
          {
            "node": "Tool 2 â€“ Prepare Scheduled Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tool 2 â€“ Prepare Scheduled Messages": {
      "main": [
        [
          {
            "node": "Tool 2 â€“ Create Scheduled Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tool 2 â€“ Create Scheduled Messages": {
      "main": [
        [
          {
            "node": "Tool 2 â€“ Format Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tool 2 â€“ Format Result": {
      "main": [
        [
          {
            "node": "Code â€“ Merge Tool Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tool 3 â€“ Parse Arguments": {
      "main": [
        [
          {
            "node": "Tool 3 â€“ Create Stripe Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tool 3 â€“ Create Stripe Session": {
      "main": [
        [
          {
            "node": "Tool 3 â€“ Format Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tool 3 â€“ Format Result": {
      "main": [
        [
          {
            "node": "Code â€“ Merge Tool Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tools 4-8 â€“ Placeholder": {
      "main": [
        [
          {
            "node": "Code â€“ Merge Tool Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code â€“ Merge Tool Results": {
      "main": [
        [
          {
            "node": "Code â€“ Process Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code â€“ Process Response": {
      "main": [
        [
          {
            "node": "Supabase â€“ Update Conversation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase â€“ Update Conversation": {
      "main": [
        [
          {
            "node": "WhatsApp â€“ Send Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WhatsApp â€“ Send Message": {
      "main": [
        [
          {
            "node": "Webhook Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-11-21T00:00:00.000Z",
      "updatedAt": "2025-11-21T00:00:00.000Z",
      "id": "1",
      "name": "Demo - Essenza Prime"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-11-21T00:00:00.000Z",
  "versionId": "2"
}