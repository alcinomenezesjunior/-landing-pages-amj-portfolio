{
  "name": "DEMO - Essenza Prime Clinic - AI Agent v2.0",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "testar-bot-whatsapp",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-whatsapp-incoming",
      "name": "Webhook â€“ WhatsApp Incoming",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 300],
      "webhookId": "essenza-prime-demo"
    },
    {
      "parameters": {
        "jsCode": "// Parse incoming WhatsApp message\nconst body = $input.item.json.body;\n\n// Extract message data\nconst phone = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.from || '';\nconst messageText = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.text?.body || '';\nconst messageId = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.id || '';\nconst timestamp = body.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.timestamp || '';\n\n// Check if this is a valid message\nif (!phone || !messageText) {\n  return {\n    json: {\n      skip: true,\n      reason: 'No valid message data'\n    }\n  };\n}\n\nreturn {\n  json: {\n    skip: false,\n    phone: phone,\n    message: messageText,\n    messageId: messageId,\n    timestamp: timestamp,\n    receivedAt: new Date().toISOString()\n  }\n};"
      },
      "id": "code-parse-message",
      "name": "Code â€“ Parse Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.skip}}",
              "value2": false
            }
          ]
        }
      },
      "id": "if-valid-message",
      "name": "IF â€“ Valid Message?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "operation": "select",
        "table": "clients",
        "filterType": "manual",
        "matchingColumns": [
          {
            "column": "phone",
            "value": "={{$json.phone}}"
          }
        ],
        "options": {}
      },
      "id": "supabase-get-client",
      "name": "Supabase â€“ Get Client",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [900, 200],
      "credentials": {
        "supabaseApi": {
          "id": "1",
          "name": "Supabase - Essenza Prime"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.length > 0}}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-client-exists",
      "name": "IF â€“ Client Exists?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1120, 200]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "clients",
        "dataMode": "defineBelow",
        "valuesToSend": {
          "values": [
            {
              "column": "phone",
              "value": "={{$('Code â€“ Parse Message').item.json.phone}}"
            }
          ]
        },
        "options": {}
      },
      "id": "supabase-create-client",
      "name": "Supabase â€“ Create Client",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1340, 320],
      "credentials": {
        "supabaseApi": {
          "id": "1",
          "name": "Supabase - Essenza Prime"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "table": "conversations",
        "filterType": "manual",
        "matchingColumns": [
          {
            "column": "phone",
            "value": "={{$('Code â€“ Parse Message').item.json.phone}}"
          }
        ],
        "options": {
          "limit": 1
        }
      },
      "id": "supabase-get-conversation",
      "name": "Supabase â€“ Get Conversation",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1560, 200],
      "credentials": {
        "supabaseApi": {
          "id": "1",
          "name": "Supabase - Essenza Prime"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Merge client and conversation data\nconst parseData = $('Code â€“ Parse Message').first().json;\nconst clientData = $('IF â€“ Client Exists?').all()[0]?.json || $('Supabase â€“ Create Client').first().json;\nconst conversationData = $input.first().json;\n\nreturn {\n  json: {\n    phone: parseData.phone,\n    message: parseData.message,\n    messageId: parseData.messageId,\n    clientId: clientData.id,\n    clientName: clientData.name || null,\n    clientEmail: clientData.email || null,\n    conversationId: conversationData.id || null,\n    conversationState: conversationData.current_state || 'inicio',\n    conversationContext: conversationData.context || {},\n    conversationHistory: conversationData.messages || []\n  }\n};"
      },
      "id": "code-merge-data",
      "name": "Code â€“ Merge Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1780, 200]
    },
    {
      "parameters": {
        "model": "claude-sonnet-4-20250514",
        "options": {
          "maxTokens": 1500,
          "temperature": 0.7,
          "systemMessage": "Ã‰s a assistente virtual da Essenza Prime Clinic, uma clÃ­nica de estÃ©tica premium em Cascais, Lisboa.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nPERSONALIDADE E TOM\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n- Nome: NÃ£o tens nome especÃ­fico, Ã©s \"a assistente da Essenza Prime\"\n- Tom: Profissional mas acolhedor, elegante, nunca robÃ³tico\n- Linguagem: PortuguÃªs de Portugal (PT-PT), NUNCA brasileiro\n  - \"telemÃ³vel\" (nÃ£o \"celular\")\n  - \"autocarro\" (nÃ£o \"Ã´nibus\")\n  - \"marcaÃ§Ã£o\" (nÃ£o \"agendamento\")\n  - \"pequeno-almoÃ§o\" (nÃ£o \"cafÃ© da manhÃ£\")\n- Estilo: Frases claras e concisas, adequadas para WhatsApp\n- Emojis: Usa com moderaÃ§Ã£o (mÃ¡ximo 2 por mensagem)\n- Comprimento: Respostas curtas para perguntas simples, detalhadas quando necessÃ¡rio\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nO TEU PAPEL\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. Apresentar a clÃ­nica e os serviÃ§os quando o cliente chega\n2. Responder a perguntas sobre procedimentos, preÃ§os, duraÃ§Ãµes\n3. Informar sobre contraindicaÃ§Ãµes quando relevante\n4. Verificar disponibilidade de horÃ¡rios (usa tool check_availability)\n5. Fazer marcaÃ§Ãµes no calendÃ¡rio (usa tool create_booking)\n6. Gerar links de pagamento para depÃ³sitos (usa tool generate_payment_link)\n7. Processar cancelamentos e reagendamentos\n8. Processar reembolsos conforme polÃ­tica\n9. Sugerir upsells apÃ³s marcaÃ§Ã£o confirmada\n10. Oferecer downsells quando cliente quer cancelar por preÃ§o\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nMENSAGEM INICIAL\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nQuando o cliente envia a primeira mensagem (ex: \"OlÃ¡\", \"Quero testar\", etc.),\nresponde com uma apresentaÃ§Ã£o elegante:\n\n\"Bem-vinda Ã  Essenza Prime Clinic! âœ¨\n\nSou a assistente virtual e posso ajudar-te com:\nâ€¢ InformaÃ§Ãµes sobre tratamentos\nâ€¢ MarcaÃ§Ã£o de consultas\nâ€¢ VerificaÃ§Ã£o de disponibilidade\n\nA nossa clÃ­nica em Cascais oferece tratamentos faciais, corporais e micropigmentaÃ§Ã£o, com uma equipa de 8 especialistas.\n\nComo posso ajudar-te hoje?\"\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nDADOS DA CLÃNICA\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nNome: Essenza Prime Clinic, Unipessoal Lda.\nMorada: Cascais, Lisboa\nHorÃ¡rio: Segunda a Sexta 10:00-19:00, SÃ¡bado 10:00-14:00\nTelefone/WhatsApp: +351 926 699 009\nEmail: atendimento@essenzaprimeclinic.pt\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nEQUIPA (8 PROFISSIONAIS)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. Dr. Gustavo MendonÃ§a â€” MÃ©dico Esteta\n   ServiÃ§os: Peelings mÃ©dio/profundo, HarmonizaÃ§Ã£o, Preenchimentos\n   HorÃ¡rio: Seg-Sex 10:00-16:00\n\n2. Dra. Bruna Cortez â€” BiomÃ©dica Esteta\n   ServiÃ§os: Microagulhamento, Peelings, Limpeza, RadiofrequÃªncia\n   HorÃ¡rio: Ter/Qui/Sex 13:00-19:00, SÃ¡b 10:00-14:00\n\n3. Sra. SÃ­lvia Ramos â€” Esteticista Facial\n   ServiÃ§os: Limpeza de pele, Massagens, RadiofrequÃªncia facial\n   HorÃ¡rio: Seg/Qua/Sex 10:00-19:00, SÃ¡b 10:00-14:00\n\n4. Sra. Carla MagalhÃ£es â€” Esteticista Corporal\n   ServiÃ§os: Massagem modeladora, Drenagem, CriolipÃ³lise, RF corporal\n   HorÃ¡rio: Seg-Sex 13:00-19:00, SÃ¡b 10:00-14:00\n\n5. Sra. InÃªs Duarte â€” Especialista MicropigmentaÃ§Ã£o\n   ServiÃ§os: Microblading, MicropigmentaÃ§Ã£o lÃ¡bios/olhos\n   HorÃ¡rio: Seg/Qua/Qui 10:00-16:00, SÃ¡b 10:00-14:00\n\n6. Sra. Larissa GalvÃ£o â€” Esteticista Multidisciplinar\n   ServiÃ§os: Limpeza, Peelings superficiais, Microagulhamento, CriolipÃ³lise\n   HorÃ¡rio: Ter 10:00-19:00, Sex 10:00-13:00\n\n7. Sr. Pedro Moreira â€” Terapeuta Corporal\n   ServiÃ§os: Massagens, RF corporal, CriolipÃ³lise\n   HorÃ¡rio: Seg/Qua/Sex 16:00-19:00, SÃ¡b 10:00-14:00\n\n8. Sra. Renata Pinto â€” Assistente/Consultora\n   ServiÃ§os: AvaliaÃ§Ã£o inicial, OrientaÃ§Ã£o\n   HorÃ¡rio: Seg-Sex 10:00-19:00, SÃ¡b 10:00-14:00\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nCATÃLOGO DE SERVIÃ‡OS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nTRATAMENTOS FACIAIS:\nâ€¢ Limpeza de Pele Profunda â€” â‚¬40 (60-90 min)\nâ€¢ Peeling Superficial â€” â‚¬80 (30-45 min)\nâ€¢ Peeling MÃ©dio â€” â‚¬160 (45-60 min)\nâ€¢ RadiofrequÃªncia Facial â€” â‚¬100 (30-45 min)\nâ€¢ Microagulhamento â€” â‚¬120 (45-60 min)\nâ€¢ Ultrassom Microfocado (HIFU) â€” â‚¬200 (60-90 min)\nâ€¢ HarmonizaÃ§Ã£o Facial â€” â‚¬600 (60-90 min)\n\nTRATAMENTOS CORPORAIS:\nâ€¢ Massagem TerapÃªutica â€” â‚¬50 (50-60 min)\nâ€¢ Massagem Modeladora â€” â‚¬60 (50-60 min)\nâ€¢ Drenagem LinfÃ¡tica â€” â‚¬60 (50-60 min)\nâ€¢ RadiofrequÃªncia Corporal â€” â‚¬100 (45-60 min)\nâ€¢ CriolipÃ³lise â€” â‚¬120 (60-90 min)\nâ€¢ Massagem Detox â€” â‚¬55 (50-60 min)\n\nMICROPIGMENTAÃ‡ÃƒO:\nâ€¢ Microblading Sobrancelhas â€” â‚¬250 (90-120 min)\nâ€¢ MicropigmentaÃ§Ã£o LÃ¡bios â€” â‚¬280 (90-120 min)\nâ€¢ MicropigmentaÃ§Ã£o Eyeliner â€” â‚¬240 (60-90 min)\n\nCONSULTAS:\nâ€¢ AvaliaÃ§Ã£o Inicial â€” Gratuita (30 min)\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nPOLÃTICA DE DEPÃ“SITO E PAGAMENTO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nâ€¢ DepÃ³sito: 50% do valor total para confirmar marcaÃ§Ã£o\nâ€¢ DepÃ³sito mÃ­nimo: â‚¬20 (se procedimento < â‚¬40)\nâ€¢ Saldo: Pago no dia do procedimento\nâ€¢ Formas: MB WAY, TransferÃªncia, Multibanco, CartÃ£o (presencial)\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nPOLÃTICA DE CANCELAMENTO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nâ€¢ 7+ dias antes: 100% reembolso\nâ€¢ 3-7 dias antes: 75% reembolso (25% retenÃ§Ã£o)\nâ€¢ < 3 dias (atÃ© 24h): 50% reembolso\nâ€¢ < 24 horas: 25% reembolso\nâ€¢ NÃ£o comparecimento (no-show): 0% reembolso\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nFLUXO DE MARCAÃ‡ÃƒO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. Cliente indica interesse num serviÃ§o\n2. Explica o serviÃ§o (duraÃ§Ã£o, preÃ§o, o que inclui)\n3. Pergunta se quer marcar\n4. Verifica disponibilidade (tool: check_availability)\n5. Apresenta 3-5 opÃ§Ãµes de horÃ¡rio\n6. Cliente escolhe\n7. Pede: nome completo e email\n8. Confirma todos os dados\n9. Gera link de pagamento (tool: generate_payment_link)\n10. Aguarda confirmaÃ§Ã£o de pagamento\n11. Cria marcaÃ§Ã£o (tool: create_booking)\n12. Envia confirmaÃ§Ã£o final\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nUPSELL (ApÃ³s MarcaÃ§Ã£o Confirmada)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nQuando uma marcaÃ§Ã£o Ã© confirmada, sugere um serviÃ§o complementar:\n\nâ€¢ Limpeza de Pele â†’ Peeling Superficial (10% desconto)\nâ€¢ Peeling Superficial â†’ RadiofrequÃªncia Facial (10%)\nâ€¢ RadiofrequÃªncia â†’ Microagulhamento (10%)\nâ€¢ Massagem TerapÃªutica â†’ Drenagem LinfÃ¡tica (15%)\nâ€¢ Microblading â†’ MicropigmentaÃ§Ã£o LÃ¡bios (10%)\nâ€¢ CriolipÃ³lise â†’ RF Corporal (15%)\n\nExemplo de mensagem:\n\"A tua marcaÃ§Ã£o estÃ¡ confirmada! âœ…\n\nğŸ’¡ Muitas clientes combinam a Limpeza de Pele com um Peeling Superficial para resultados ainda melhores.\n\nğŸ Por marcares agora, tens 10% de desconto: â‚¬80 â†’ â‚¬72\n\nQueres adicionar? A Dra. Bruna tem disponibilidade logo apÃ³s.\"\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nDOWNSELL (No Cancelamento por PreÃ§o)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSe o cliente quer cancelar e menciona preÃ§o/dinheiro:\n\nâ€¢ Peeling MÃ©dio (â‚¬160) â†’ Peeling Superficial (â‚¬80)\nâ€¢ HarmonizaÃ§Ã£o (â‚¬600) â†’ RadiofrequÃªncia Facial (â‚¬100)\nâ€¢ Microagulhamento (â‚¬120) â†’ Limpeza de Pele (â‚¬40)\n\nExemplo:\n\"Entendo que o Peeling MÃ©dio Ã© um investimento maior.\n\nTenho uma alternativa: o Peeling Superficial (â‚¬80) tambÃ©m melhora manchas e textura, com menos tempo de recuperaÃ§Ã£o.\n\nO teu depÃ³sito de â‚¬80 cobre o valor total! Queres trocar em vez de cancelar?\"\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nLIVRO DE RECLAMAÃ‡Ã•ES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSe perguntarem sobre reclamaÃ§Ãµes:\n\n\"A Essenza Prime Clinic disponibiliza o Livro de ReclamaÃ§Ãµes EletrÃ³nico conforme a legislaÃ§Ã£o portuguesa.\n\nPodes aceder em: www.livroreclamacoes.pt\n\nSe preferires resolver directamente, posso pedir a um responsÃ¡vel para te contactar. O que preferes?\"\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nREGRAS IMPORTANTES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. NUNCA inventes informaÃ§Ã£o â€” usa apenas o que estÃ¡ acima\n2. NUNCA digas que Ã©s demo ou teste â€” age como assistente real\n3. SEMPRE verifica disponibilidade antes de confirmar marcaÃ§Ã£o\n4. SEMPRE confirma dados antes de criar evento\n5. SEMPRE informa sobre depÃ³sito de 50%\n6. SEMPRE usa PT-PT, nunca portuguÃªs do Brasil\n7. Se nÃ£o souberes algo, oferece contacto humano:\n   \"Posso pedir a um colega para te contactar para esclarecer isso.\"\n8. SÃª empÃ¡tica com cancelamentos â€” nÃ£o julgues\n9. Quando o cliente mencionar dificuldade financeira, oferece alternativas\n10. MantÃ©m histÃ³rico da conversa â€” nÃ£o perguntes o que jÃ¡ foi dito"
        },
        "chatHistory": "={{$json.conversationHistory}}",
        "prompt": "={{$json.message}}",
        "tools": [
          {
            "name": "check_availability",
            "description": "Verifica horÃ¡rios disponÃ­veis no Google Calendar para um serviÃ§o/profissional",
            "parameters": {
              "type": "object",
              "properties": {
                "service_name": {
                  "type": "string",
                  "description": "Nome do serviÃ§o (ex: 'Limpeza de Pele Profunda')"
                },
                "professional_name": {
                  "type": "string",
                  "description": "Nome do profissional preferido (opcional)"
                },
                "date_from": {
                  "type": "string",
                  "description": "Data inicial no formato YYYY-MM-DD"
                },
                "date_to": {
                  "type": "string",
                  "description": "Data final no formato YYYY-MM-DD"
                }
              },
              "required": ["service_name", "date_from", "date_to"]
            }
          },
          {
            "name": "create_booking",
            "description": "Cria uma marcaÃ§Ã£o no Google Calendar e regista no Supabase",
            "parameters": {
              "type": "object",
              "properties": {
                "service_name": {"type": "string"},
                "professional_name": {"type": "string"},
                "date": {"type": "string", "description": "YYYY-MM-DD"},
                "time_start": {"type": "string", "description": "HH:MM"},
                "duration_minutes": {"type": "integer"},
                "client_name": {"type": "string"},
                "client_phone": {"type": "string"},
                "client_email": {"type": "string"},
                "price": {"type": "number"},
                "deposit": {"type": "number"},
                "stripe_payment_id": {"type": "string"}
              },
              "required": ["service_name", "professional_name", "date", "time_start", "duration_minutes", "client_name", "client_phone", "price"]
            }
          },
          {
            "name": "generate_payment_link",
            "description": "Gera um link Stripe Checkout para pagamento do depÃ³sito",
            "parameters": {
              "type": "object",
              "properties": {
                "amount_cents": {"type": "integer", "description": "Valor em cÃªntimos"},
                "service_name": {"type": "string"},
                "client_email": {"type": "string"},
                "client_phone": {"type": "string"},
                "booking_date": {"type": "string"},
                "booking_time": {"type": "string"}
              },
              "required": ["amount_cents", "service_name", "client_phone"]
            }
          },
          {
            "name": "cancel_booking",
            "description": "Cancela uma marcaÃ§Ã£o e processa reembolso conforme polÃ­tica",
            "parameters": {
              "type": "object",
              "properties": {
                "client_phone": {"type": "string"},
                "booking_date": {"type": "string", "description": "YYYY-MM-DD"},
                "reason": {"type": "string", "description": "Motivo do cancelamento"}
              },
              "required": ["client_phone", "booking_date"]
            }
          },
          {
            "name": "reschedule_booking",
            "description": "Reagenda uma marcaÃ§Ã£o para nova data/hora",
            "parameters": {
              "type": "object",
              "properties": {
                "client_phone": {"type": "string"},
                "old_date": {"type": "string"},
                "new_date": {"type": "string"},
                "new_time": {"type": "string"}
              },
              "required": ["client_phone", "old_date", "new_date", "new_time"]
            }
          },
          {
            "name": "process_refund",
            "description": "Processa reembolso via Stripe",
            "parameters": {
              "type": "object",
              "properties": {
                "stripe_payment_id": {"type": "string"},
                "refund_percentage": {"type": "integer", "description": "0-100"},
                "reason": {"type": "string"}
              },
              "required": ["stripe_payment_id", "refund_percentage"]
            }
          },
          {
            "name": "get_care_instructions",
            "description": "ObtÃ©m cuidados prÃ© ou pÃ³s procedimento",
            "parameters": {
              "type": "object",
              "properties": {
                "service_name": {"type": "string"},
                "instruction_type": {"type": "string", "enum": ["pre", "post"]}
              },
              "required": ["service_name", "instruction_type"]
            }
          },
          {
            "name": "get_professional_info",
            "description": "ObtÃ©m informaÃ§Ã£o sobre um profissional",
            "parameters": {
              "type": "object",
              "properties": {
                "professional_name": {"type": "string"},
                "info_type": {"type": "string", "enum": ["services", "schedule", "bio"]}
              },
              "required": ["professional_name"]
            }
          }
        ]
      },
      "id": "ai-agent-claude",
      "name": "AI Agent â€“ Claude Sonnet 4",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [2000, 200],
      "credentials": {
        "anthropicApi": {
          "id": "1",
          "name": "Anthropic API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Process AI response and prepare for database update\nconst aiResponse = $input.first().json;\nconst mergedData = $('Code â€“ Merge Data').first().json;\n\n// Add new message to history\nconst messages = mergedData.conversationHistory || [];\nmessages.push({\n  role: 'user',\n  content: mergedData.message,\n  timestamp: new Date().toISOString()\n});\nmessages.push({\n  role: 'assistant',\n  content: aiResponse.output,\n  timestamp: new Date().toISOString()\n});\n\n// Keep only last 20 messages for context\nconst trimmedMessages = messages.slice(-20);\n\n// Extract any booking intent from context\nconst hasBookingIntent = aiResponse.output.toLowerCase().includes('marcar') || \n                         aiResponse.output.toLowerCase().includes('disponibilidade');\n\nreturn {\n  json: {\n    phone: mergedData.phone,\n    clientId: mergedData.clientId,\n    conversationId: mergedData.conversationId,\n    messages: trimmedMessages,\n    currentState: hasBookingIntent ? 'choosing_service' : mergedData.conversationState,\n    responseText: aiResponse.output,\n    toolsUsed: aiResponse.toolCalls || []\n  }\n};"
      },
      "id": "code-process-response",
      "name": "Code â€“ Process Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2220, 200]
    },
    {
      "parameters": {
        "operation": "upsert",
        "table": "conversations",
        "dataMode": "defineBelow",
        "valuesToSend": {
          "values": [
            {
              "column": "client_id",
              "value": "={{$json.clientId}}"
            },
            {
              "column": "phone",
              "value": "={{$json.phone}}"
            },
            {
              "column": "messages",
              "value": "={{JSON.stringify($json.messages)}}"
            },
            {
              "column": "current_state",
              "value": "={{$json.currentState}}"
            }
          ]
        },
        "options": {}
      },
      "id": "supabase-update-conversation",
      "name": "Supabase â€“ Update Conversation",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [2440, 200],
      "credentials": {
        "supabaseApi": {
          "id": "1",
          "name": "Supabase - Essenza Prime"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v18.0/{{$env.WHATSAPP_PHONE_NUMBER_ID}}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{$('Code â€“ Process Response').item.json.phone}}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"{{$('Code â€“ Process Response').item.json.responseText}}\"\n  }\n}",
        "options": {}
      },
      "id": "whatsapp-send-message",
      "name": "WhatsApp â€“ Send Message",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2660, 200],
      "credentials": {
        "httpHeaderAuth": {
          "id": "2",
          "name": "WhatsApp Cloud API Token"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"status\": \"success\", \"message\": \"Message processed\"}"
      },
      "id": "webhook-response",
      "name": "Webhook Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2880, 200]
    }
  ],
  "connections": {
    "Webhook â€“ WhatsApp Incoming": {
      "main": [[{"node": "Code â€“ Parse Message", "type": "main", "index": 0}]]
    },
    "Code â€“ Parse Message": {
      "main": [[{"node": "IF â€“ Valid Message?", "type": "main", "index": 0}]]
    },
    "IF â€“ Valid Message?": {
      "main": [[{"node": "Supabase â€“ Get Client", "type": "main", "index": 0}]]
    },
    "Supabase â€“ Get Client": {
      "main": [[{"node": "IF â€“ Client Exists?", "type": "main", "index": 0}]]
    },
    "IF â€“ Client Exists?": {
      "main": [
        [{"node": "Supabase â€“ Get Conversation", "type": "main", "index": 0}],
        [{"node": "Supabase â€“ Create Client", "type": "main", "index": 0}]
      ]
    },
    "Supabase â€“ Create Client": {
      "main": [[{"node": "Supabase â€“ Get Conversation", "type": "main", "index": 0}]]
    },
    "Supabase â€“ Get Conversation": {
      "main": [[{"node": "Code â€“ Merge Data", "type": "main", "index": 0}]]
    },
    "Code â€“ Merge Data": {
      "main": [[{"node": "AI Agent â€“ Claude Sonnet 4", "type": "main", "index": 0}]]
    },
    "AI Agent â€“ Claude Sonnet 4": {
      "main": [[{"node": "Code â€“ Process Response", "type": "main", "index": 0}]]
    },
    "Code â€“ Process Response": {
      "main": [[{"node": "Supabase â€“ Update Conversation", "type": "main", "index": 0}]]
    },
    "Supabase â€“ Update Conversation": {
      "main": [[{"node": "WhatsApp â€“ Send Message", "type": "main", "index": 0}]]
    },
    "WhatsApp â€“ Send Message": {
      "main": [[{"node": "Webhook Response", "type": "main", "index": 0}]]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-11-21T00:00:00.000Z",
      "updatedAt": "2025-11-21T00:00:00.000Z",
      "id": "1",
      "name": "Demo - Essenza Prime"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-11-21T00:00:00.000Z",
  "versionId": "1"
}
