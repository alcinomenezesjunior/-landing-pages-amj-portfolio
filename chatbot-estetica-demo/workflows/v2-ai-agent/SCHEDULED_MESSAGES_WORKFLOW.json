{
  "name": "Scheduled Messages - Essenza Prime",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 5
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Schedule Trigger â€“ Every 5 Minutes",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [240, 300]
    },
    {
      "parameters": {
        "operation": "select",
        "table": "scheduled_messages",
        "filterType": "manual",
        "matchingColumns": [
          {
            "column": "sent",
            "value": "false"
          }
        ],
        "options": {
          "limit": 50
        }
      },
      "id": "supabase-get-pending-messages",
      "name": "Supabase â€“ Get Pending Messages",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [460, 300],
      "credentials": {
        "supabaseApi": {
          "id": "1",
          "name": "Supabase - Essenza Prime"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Filter messages that should be sent NOW\nconst messages = $input.all();\nconst now = new Date();\n\nconst readyToSend = messages.filter(item => {\n  const scheduledFor = new Date(item.json.scheduled_for);\n  return scheduledFor <= now;\n});\n\nreturn readyToSend.map(item => ({json: item.json}));"
      },
      "id": "code-filter-ready-messages",
      "name": "Code â€“ Filter Ready Messages",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{$input.all().length}}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "id": "if-has-messages",
      "name": "IF â€“ Has Messages?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [900, 300]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "split-in-batches",
      "name": "Split In Batches",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [1120, 200]
    },
    {
      "parameters": {
        "operation": "select",
        "table": "appointments",
        "filterType": "manual",
        "matchingColumns": [
          {
            "column": "id",
            "value": "={{$json.appointment_id}}"
          }
        ],
        "options": {}
      },
      "id": "supabase-get-appointment",
      "name": "Supabase â€“ Get Appointment",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1340, 200],
      "credentials": {
        "supabaseApi": {
          "id": "1",
          "name": "Supabase - Essenza Prime"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "table": "services",
        "filterType": "manual",
        "matchingColumns": [
          {
            "column": "name",
            "value": "={{$('Supabase â€“ Get Appointment').item.json.service}}"
          }
        ],
        "options": {}
      },
      "id": "supabase-get-service",
      "name": "Supabase â€“ Get Service",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1560, 200],
      "credentials": {
        "supabaseApi": {
          "id": "1",
          "name": "Supabase - Essenza Prime"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "table": "clients",
        "filterType": "manual",
        "matchingColumns": [
          {
            "column": "id",
            "value": "={{$('Supabase â€“ Get Appointment').item.json.client_id}}"
          }
        ],
        "options": {}
      },
      "id": "supabase-get-client",
      "name": "Supabase â€“ Get Client",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1780, 200],
      "credentials": {
        "supabaseApi": {
          "id": "1",
          "name": "Supabase - Essenza Prime"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Prepare message content based on type\nconst messageRecord = $('Split In Batches').item.json;\nconst appointment = $('Supabase â€“ Get Appointment').first().json;\nconst service = $('Supabase â€“ Get Service').first().json;\nconst client = $('Supabase â€“ Get Client').first().json;\n\nconst messageType = messageRecord.message_type;\nconst clientName = client.name || 'Cliente';\nconst serviceName = appointment.service;\nconst professional = appointment.professional;\nconst date = appointment.date;\nconst time = appointment.time_start;\nconst price = parseFloat(appointment.price);\nconst deposit = parseFloat(appointment.deposit || 0);\nconst saldo = price - deposit;\n\nlet messageContent = '';\n\nswitch(messageType) {\n  case 'reminder_24h':\n    messageContent = `OlÃ¡ ${clientName}! ğŸ‘‹\\n\\n`;\n    messageContent += `Lembramos que tens marcaÃ§Ã£o amanhÃ£:\\n`;\n    messageContent += `ğŸ“… ${date} Ã s ${time}\\n`;\n    messageContent += `ğŸ’† ${serviceName}\\n`;\n    messageContent += `ğŸ‘©â€âš•ï¸ Com: ${professional}\\n\\n`;\n    messageContent += `ğŸ“ Cascais, Lisboa\\n\\n`;\n    \n    if (service.pre_care) {\n      messageContent += `âš ï¸ PREPARAÃ‡ÃƒO IMPORTANTE:\\n${service.pre_care}\\n\\n`;\n    }\n    \n    if (saldo > 0) {\n      messageContent += `ğŸ’³ Saldo a pagar: â‚¬${saldo.toFixed(2)}\\n\\n`;\n    }\n    \n    messageContent += `AtÃ© amanhÃ£! âœ¨`;\n    break;\n    \n  case 'reminder_1h':\n    messageContent = `OlÃ¡ ${clientName}!\\n\\n`;\n    messageContent += `A tua consulta Ã© daqui a 1 hora:\\n`;\n    messageContent += `ğŸ• ${time}\\n`;\n    messageContent += `ğŸ’† ${serviceName}\\n\\n`;\n    messageContent += `ğŸ“ Essenza Prime Clinic - Cascais\\n\\n`;\n    messageContent += `AtÃ© jÃ¡! ğŸ˜Š`;\n    break;\n    \n  case 'post_care':\n    messageContent = `OlÃ¡ ${clientName}! ğŸ˜Š\\n\\n`;\n    messageContent += `Esperamos que tenhas gostado do teu ${serviceName}!\\n\\n`;\n    \n    if (service.post_care) {\n      messageContent += `ğŸŒŸ CUIDADOS PARA OS PRÃ“XIMOS DIAS:\\n${service.post_care}\\n\\n`;\n    }\n    \n    messageContent += `â“ Alguma dÃºvida? Responde a esta mensagem!\\n\\n`;\n    messageContent += `Essenza Prime Clinic âœ¨`;\n    break;\n    \n  case 'follow_up_7d':\n    messageContent = `OlÃ¡ ${clientName}! ğŸ‘‹\\n\\n`;\n    messageContent += `JÃ¡ passaram 7 dias desde o teu ${serviceName}.\\n`;\n    messageContent += `Como estÃ¡s a sentir os resultados?\\n\\n`;\n    \n    if (service.upsell_service && service.upsell_discount) {\n      messageContent += `ğŸ’¡ Lembras-te do ${service.upsell_service} que sugerimos?\\n`;\n      messageContent += `Ainda tens ${service.upsell_discount}% de desconto esta semana!\\n\\n`;\n    }\n    \n    messageContent += `Queres marcar a prÃ³xima sessÃ£o?`;\n    break;\n    \n  default:\n    messageContent = messageRecord.message_content || 'Mensagem da Essenza Prime Clinic';\n}\n\nreturn {\n  json: {\n    phone: messageRecord.client_phone,\n    message: messageContent,\n    messageId: messageRecord.id\n  }\n};"
      },
      "id": "code-prepare-message",
      "name": "Code â€“ Prepare Message Content",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2000, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://graph.facebook.com/v18.0/{{$env.WHATSAPP_PHONE_NUMBER_ID}}/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{$json.phone}}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"body\": \"{{$json.message}}\"\n  }\n}",
        "options": {}
      },
      "id": "whatsapp-send-message",
      "name": "WhatsApp â€“ Send Message",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2220, 200],
      "credentials": {
        "httpHeaderAuth": {
          "id": "2",
          "name": "WhatsApp Cloud API Token"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "table": "scheduled_messages",
        "filterType": "manual",
        "matchingColumns": [
          {
            "column": "id",
            "value": "={{$('Code â€“ Prepare Message Content').item.json.messageId}}"
          }
        ],
        "dataMode": "defineBelow",
        "valuesToSend": {
          "values": [
            {
              "column": "sent",
              "value": true
            },
            {
              "column": "sent_at",
              "value": "={{new Date().toISOString()}}"
            }
          ]
        },
        "options": {}
      },
      "id": "supabase-mark-as-sent",
      "name": "Supabase â€“ Mark as Sent",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [2440, 200],
      "credentials": {
        "supabaseApi": {
          "id": "1",
          "name": "Supabase - Essenza Prime"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "loop-back",
      "name": "Loop Back to Split",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [2660, 200]
    }
  ],
  "connections": {
    "Schedule Trigger â€“ Every 5 Minutes": {
      "main": [[{"node": "Supabase â€“ Get Pending Messages", "type": "main", "index": 0}]]
    },
    "Supabase â€“ Get Pending Messages": {
      "main": [[{"node": "Code â€“ Filter Ready Messages", "type": "main", "index": 0}]]
    },
    "Code â€“ Filter Ready Messages": {
      "main": [[{"node": "IF â€“ Has Messages?", "type": "main", "index": 0}]]
    },
    "IF â€“ Has Messages?": {
      "main": [[{"node": "Split In Batches", "type": "main", "index": 0}]]
    },
    "Split In Batches": {
      "main": [[{"node": "Supabase â€“ Get Appointment", "type": "main", "index": 0}]]
    },
    "Supabase â€“ Get Appointment": {
      "main": [[{"node": "Supabase â€“ Get Service", "type": "main", "index": 0}]]
    },
    "Supabase â€“ Get Service": {
      "main": [[{"node": "Supabase â€“ Get Client", "type": "main", "index": 0}]]
    },
    "Supabase â€“ Get Client": {
      "main": [[{"node": "Code â€“ Prepare Message Content", "type": "main", "index": 0}]]
    },
    "Code â€“ Prepare Message Content": {
      "main": [[{"node": "WhatsApp â€“ Send Message", "type": "main", "index": 0}]]
    },
    "WhatsApp â€“ Send Message": {
      "main": [[{"node": "Supabase â€“ Mark as Sent", "type": "main", "index": 0}]]
    },
    "Supabase â€“ Mark as Sent": {
      "main": [[{"node": "Loop Back to Split", "type": "main", "index": 0}]]
    },
    "Loop Back to Split": {
      "main": [[{"node": "Split In Batches", "type": "main", "index": 0}]]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-11-21T00:00:00.000Z",
      "updatedAt": "2025-11-21T00:00:00.000Z",
      "id": "1",
      "name": "Demo - Essenza Prime"
    }
  ],
  "triggerCount": 0,
  "updatedAt": "2025-11-21T00:00:00.000Z",
  "versionId": "1"
}
